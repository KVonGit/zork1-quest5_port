<?xml version="1.0"?>
<!--
  ACTIONS for ZORK 1
  (1ACTIONS.ZIL)
-->
<library>
  <function name="WEST_HOUSE" parameters="RARG" type="boolean">
    if (RARG = "M_LOOK") {
      TELL ("You are standing in an open field west of a white house, with a boarded front door.")
      if (GLOBAL.WON_FLAG) {
        TELL (" A secret path leads southwest into the forest.")
      }
      CRLF
      return (true)
    }
    return (false)
  </function>

  <function name="EAST_HOUSE" parameters="RARG" type="boolean">
    if (RARG = "M_LOOK") {
      TELL ("You are behind the white house. A path leads into the forest to the east. In one corner of the house there is a small {object:KITCHEN_WINDOW:window} which is ")
      if (KITCHEN_WINDOW.isopen) {
        msg ("open.")
      }
      else {
        msg ("closed.")
      }
      THIS_IS_IT (KITCHEN_WINDOW)
      return (true)
    }
    return (false)
  </function>

  <function name="OPEN_CLOSE" parameters="OBJ, STROPN, STRCLS">
    if (VERB_P(V_OPEN)) {
      if (FSET_P(OBJ,"OPENBIT")) {
        msg (PICK_ONE(GLOBAL.DUMMY))
      }
      else {
        OBJ.OPENBIT = true
        OBJ.isopen = true
        msg (STROPN)
      }
    }
    else {
      if (FSET_P(OBJ,"OPENBIT")) {
        OBJ.OPENBIT = false
        OBJ.isopen = false
        msg (STRCLS)
      }
      else {
        msg (PICK_ONE(GLOBAL.DUMMY))
      }
    }
  </function>

  <function name="BOARD_F" type="boolean">
    if (VERB_P(V_TAKE) or VERB_P(V_EXAMINE)) {
      msg ("The boards are securely fastened.")
      return (true)
    }
    return (false)
  </function>

  <function name="TEETH_F" type="boolean">
    if (GLOBAL.PRSA = V_BRUSH and GLOBAL.PRSO = TEETH) {
      if (GLOBAL.PRSI = PUTTY and LOC(PUTTY) = GLOBAL.WINNER) {
        JIGS_UP ("Well, you seem to have been brushing your teeth with some sort of glue. As a result, your mouth gets glued together (with your nose) and you die of respiratory failure.")
        return (true)
      }
      else if (GLOBAL.PRSI = NOTHING) {
        msg ("Dental hygiene is highly recommended, but I'm not sure what you want to brush them with.")
        return (true)
      }
      else {
        msg ("A nice idea, but with a " +  GLOBAL.PRSI.alias + "?")
        return (true)
      }
    }
    return (false)
  </function>

  <function name="GRANITE_WALL_F" type="boolean">
    if (GLOBAL.HERE = NORTH_TEMPLE) {
      if (GLOBAL.PRSA = V_FIND) {
        msg ("The west wall is solid granite here.")
        return (true)
      }
      else if (GLOBAL.PRSA = V_TAKE or GLOBAL.PRSA = V_RAISE or GLOBAL.PRSA = V_LOWER) {
        msg ("It's solid granite")
        return (true)
      }
    }
    else if (GLOBAL.HERE = TREASURE_ROOM) {
      if (GLOBAL.PRSA = V_FIND) {
        msg ("The east wall is solid granite here.")
        return (true)
      }
      else if (GLOBAL.PRSA = V_TAKE or GLOBAL.PRSA = V_RAISE or GLOBAL.PRSA = V_LOWER) {
        msg ("It's solid granite")
        return (true)
      }
    }
    else if (GLOBAL.HERE = SLIDE_ROOM) {
      if (GLOBAL.PRSA = V_FIND or GLOBAL.PRSA = V_READ) {
        msg ("It only SAYS \"Granite Wall\".")
        return (true)
      }
      else {
        msg ("The wall isn't granite.")
        return (true)
      }
    }
    else {
      msg ("There is no granite wall here.")
      return (true)
    }
    return (false)
  </function>

  <function name="SONGBIRD_F" type="boolean">
    switch (GLOBAL.PRSA) {
      case (FIND, take) {
        msg ("The songbird is not here but is probably nearby.")
        return (true)
      }
      case (listen) {
        msg ("You can't hear the songbird now.")
        return (true)
      }
      case (FOLLOW) {
        msg ("It can't be followed.")
        return (true)
      }
      default {
        msg ("You can't see any songbird here.")
        return (true)
      }
    }
    return (false)
  </function>

  <function name="WHITE_HOUSE_F" type="boolean">
    if (GLOBAL.HERE = KITCHEN or GLOBAL.HERE = LIVING_ROOM or GLOBAL.HERE = ATTIC) {
      if (GLOBAL.PRSA = V_FIND) {
        msg ("Why not find your brains?")
        return (true)
      }
      else if (GLOBAL.PRSA = V_WALK_AROUND) {
        GO_NEXT (GLOBAL.IN_HOUSE_AROUND)
        return (true)
      }
    }
    else if (not GLOBAL.HERE = EAST_OF_HOUSE and not GLOBAL.HERE = WEST_OF_HOUSE and not GLOBAL.HERE = NORTH_OF_HOUSE and not GLOBAL.HERE = CLEARING) {
      if (GLOBAL.PRSA = V_FIND) {
        if (GLOBAL.HERE = CLEARING) {
          msg ("It seems to be to the west.")
          return (true)
        }
        else {
          msg ("It was here just a minute ago....")
          return (true)
        }
      }
      else {
        msg ("You're not at the house.")
        return (true)
      }
    }
    else if (GLOBAL.PRSA = V_FIND) {
      msg ("It's right here! Are you blind or something?")
      return (true)
    }
    else if (GLOBAL.PRSA = V_WALK_AROUND) {
      GO_NEXT (GLOBAL.HOUSE_AROUND)
      return (true)
    }
    else if (GLOBAL.PRSA = V_EXAMINE) {
      msg ("The house is a beautiful colonial house which is painted white. It is clear that the owners must have been extremely wealthy.")
      return (true)
    }
    else if (GLOBAL.PRSA = V_THROUGH or GLOBAL.PRSA = V_OPEN) {
      if (GLOBAL.HERE = EAST_OF_HOUSE) {
        if (FSET_P(KITCHEN_WINDOW, "OPENBIT")) {
          GOTO (KITCHEN, true)
        }
        else {
          msg ("The window is closed.")
          THIS_IS_IT (KITCHEN_WINDOW)
        }
        return (true)
      }
      else {
        msg ("I can't see how to get in from here.")
        return (true)
      }
    }
    else if (GLOBAL.PRSA = V_BURN) {
      msg ("You must be joking")
      return (true)
    }
    return (false)
  </function>

  <function name="GO_NEXT" parameters="TBL" type="int"><![CDATA[
    dLog("[GO_NEXT]...")
    dLog("[GO_NEXT]: TBL is ")
    dLog(TBL)
    VAL = DictionaryItem(LKP(GLOBAL.HERE, TBL),"result")
    if(game.debugging){
      TELL("[GO_NEXT] VAL IS ")
      msg(VAL)
    }
    if (VAL <> null) {
      if (not GOTO(VAL)) {
        return (2)
      }
      else {
        return (1)
      }
    }
    return(1)
  ]]></function>

  <function name="FOREST_F" type="boolean">
    if (GLOBAL.PRSA = V_WALK_AROUND) {
      if (GLOBAL.HERE = WEST_OF_HOUSE or GLOBAL.HERE = NORTH_OF_HOUSE or GLOBAL.HERE = SOUTH_OF_HOUSE or GLOBAL.HERE = EAST_OF_HOUSE) {
        msg ("you aren't even in the forest.")
        return (true)
      }
      GO_NEXT (GLOBAL.FOREST_AROUND)
      return (true)
    }
    else if (GLOBAL.PRSA = V_DISEMBARK) {
      msg ("You will have to specify a direction.")
      return (true)
    }
    else if (GLOBAL.PRSA = V_FIND) {
      msg ("You cannot see the forest for the trees.")
      return (true)
    }
    else if (GLOBAL.PRSA = V_LISTEN) {
      msg ("The pines and the hemlocks seem to be murmuring.")
      return (true)
    }
    return (false)
  </function>

  <function name="MOUNTAIN_RANGE_F" type="boolean">
    switch (GLOBAL.PRSA) {
      case (V_CLIMB_UP,V_CLIMB_DOWN,V_CLIMB_FOO) {
        msg ("Don't you believe me? The mountains are impassable!")
        return (true)
      }
    }
    return (false)
  </function>

  <function name="WATER_F" type="boolean">
    // TODO - Check that this returns true in the right places!
    // The following is a direct conversion of the ZIL:
    if (VERB_P(V_SGIVE)) {
      return (false)
    }
    else if (VERB_P(V_THROUGH) or VERB_P(V_BOARD)) {
      msg (PICK_ONE(GLOBAL.SWIMYUKS))
      return (true)
    }
    else if (VERB_P(V_FILL)) {
      W = GLOBAL.PRSI
      GLOBAL.PRSA = V_PUT
      GLOBAL.PRSI = GLOBAL.PRSO
      GLOBAL.PRSO = W
      PI_P = false
    }
    else if (GLOBAL.PRSO = GLOBAL_WATER or GLOBAL.PRSO = WATER) {
      W = GLOBAL.PRSO
      PI_P = false
    }
    else {
      W = GLOBAL.PRSI
      if (not W = NOTHING) {
        PI_P = true
      }
    }
    if (W = GLOBAL_WATER) {
      W = WATER
      if (VERB_P(V_TAKE) or VERB_P(V_PUT)) {
        REMOVE_CAREFULLY (W)
        // TODO - adding a return here
        return (true)
      }
    }
    if (PI_P) {
      GLOBAL.PRSI = W
    }
    else {
      GLOBAL.PRSO = W
    }
    AV = LOC(GLOBAL.WINNER)
    if (not HasAttribute(AV, "VEHBIT")) {
      AV = NOTHING
    }
    if (VERB_P(V_TAKE) or VERB_P(V_PUT) and not PI_P) {
      if ((not AV = NOTHING) and (AV = GLOBAL.PRSI or (GLOBAL.PRSI = NOTHING and not IN_P(W,AV)))) {
        msg ("There is now a puddle in the bottom of the " + AV.alias + ".")
        REMOVE_CAREFULLY (GLOBAL.PRSO)
        MOVE (GLOBAL.PRSO, AV)
        // TODO = added return
        return (true)
      }
      else if (not GLOBAL.PRSI = NOTHING and not GLOBAL.PRSI = BOTTLE) {
        msg ("The water leaks out of the " + GLOBAL.PRSI.alias + " and evaporates immediately.")
        REMOVE_CAREFULLY (W)
        // TODO = added return
        return (true)
      }
      else if (IN_P(BOTTLE,GLOBAL.WINNER)) {
        if (not FSET_P(BOTTLE,"OPENBIT")) {
          msg ("The bottle is closed.")
          THIS_IS_IT (BOTTLE)
          // TODO - added return
          return (true)
        }
        else if (not FIRST_P(BOTTLE)) {
          MOVE (WATER, BOTTLE)
          msg ("The bottle is now full of water.")
          // TODO - added return
          return (true)
        }
        else {
          msg ("The water slips through your fingers.")
          return (true)
        }
      }
      else if (IN_P(GLOBAL.PRSO,BOTTLE) and VERB_P(V_TAKE) and GLOBAL.PRSI = NOTHING) {
        msg ("It's in the bottle. Perhaps you should take that instead.")
        // TODO - added return
        return (true)
      }
      else {
        msg ("The water slips through your fingers.")
        // TODO - added return
        return (true)
      }
    }
    else if (PI_P) {
      if (VERB_P(V_DROP) and GLOBAL_IN_P(RIVER, GLBOAL.HERE)) {
        PERFORM (V_PUT, GLOBAL.PRSO, RIVER)
      }
      else {
        msg ("Nice try.")
      }
      return (true)
    }
    else if (VERB_P(V_DROP) or VERB_P(V_GIVE)) {
      if (VERB_P(V_DROP) and IN_P(WATER,BOTTLE) and not FSET_P(BOTTLE, "OPENBIT")) {
        msg ("The bottle is closed.")
        return (true)
      }
      REMOVE_CAREFULLY (WATER)
      if (not AV = NOTHING) {
        msg ("There is now a puddle at the bottom of the " + AV.alias + ".")
        MOVE (WATER, AV)
        // TODO - added return
        return (true)
      }
      else {
        msg ("The water spills to the floor and evaporates immediately.")
        REMOVE_CAREFULLY (WATER)
        // TODO - added return
        return (true)
      }
    }
    else if (VERB_P(V_THROW)) {
      msg ("The water splashes on the walls and evaporates immediately.")
      REMOVE_CAREFULLY (WATER)
      // TODO - added return
      return (true)
    }
    // TODO - added return
    return (false)
  </function>

  <function name="KITCHEN_WINDOW_F" type="boolean">
    if (GLOBAL.PRSA = V_OPEN or GLOBAL.PRSA = V_CLOSE) {
      GLOBAL.KITCHEN_WINDOW_FLAG = true
      OPEN_CLOSE (KITCHEN_WINDOW, "With great effort, you open the window far enough to allow entry.", "The window closes (more easily than it opened).")
      return (true)
    }
    else if (VERB_P(V_EXAMINE) and not GLOBAL.KITCHEN_WINDOW_FLAG) {
      msg ("The window is slightly ajar, but not enough to allow entry.")
      return (true)
    }
    else if (VERB_P(V_WALK) or VERB_P(V_BOARD) or VERB_P(V_THROUGH)) {
      if (GLOBAL.HERE = KITCHEN) {
        DO_WALK ("east")
      }
      else {
        DO_WALK ("west")
      }
      return (true)
    }
    else if (VERB_P(V_LOOK_INSIDE)) {
      TELL ("You can see ")
      if (GLOBAL.HERE = KITCHEN) {
        TELL ("a clear area leading towards the forest.")
      }
      else {
        TELL ("what appears to be a kitchen.")
      }
      CRLF
      return (true)
    }
    return (false)
  </function>

  <function name="GHOSTS_F" type="boolean">
    if (GLOBAL.PRSA = V_TELL) {
      msg ("The spirits jeer loudly and ignore you.")
      GLOBAL.P_CONT = false
    }
    else if (GLOBAL.PRSA = V_EXORCISE) {
      msg ("Only the ceremony itself has any effect.")
    }
    else if ((GLOBAL.PRSA = V_ATTACK or GLOBAL.PRSA = V_MUNG) and GLOBAL.PRSO = GHOSTS) {
      msg ("How can you attack a spirit with material objects?")
    }
    else {
      msg ("You seem unable to interact with these spirits.")
    }
    return (true)
  </function>

  <function name="BASKET_F" type="boolean">
    if (VERB_P(V_RAISE)) {
      if (GLOBAL.CAGE_TOP) {
        msg (PICK_ONE(GLOBAL.DUMMY))
      }
      else {
        MOVE (RAISED_BASKET, SHAFT_ROOM)
        MOVE (LOWERED_BASKET, LOWER_SHAFT)
        GLOBAL.CAGE_TOP = true
        THIS_IS_IT (RAISED_BASKET)
        msg ("The basket is raised to the top of the shaft.")
      }
      return (true)
    }
    else if (VERB_P (V_LOWER)) {
      if (not GLOBAL.CAGE_TOP) {
        msg (PICK_ONE(GLOBAL.DUMMY))
      }
      else {
        MOVE (RAISED_BASKET, LOWER_SHAFT)
        MOVE (LOWERED_BASKET, SHAFT_ROOM)
        THIS_IS_IT (LOWERED_BASKET)
        msg ("The basket is lowered to the bottom of the shaft.")
        GLOBAL.CAGE_TOP = false
        if (GLOBAL.LIT and not LIT_P (GLOBAL.HERE)) {
          GLOBAL.LIT = LIT_P (GLOBAL.HERE)
          msg ("It is now pitch black.")
        }
        else {
          GLOBAL.LIT = LIT_P (GLOBAL.HERE)
        }  
      }
      return (true)
    }
    else if (GLOBAL.PRSO = LOWERED_BASKET or GLOBAL.PRSI = LOWERED_BASKET) {
      msg ("The basket is at the other end of the chain.")
      return (true)
    }
    else if (VERB_P (V_TAKE) and EQUAL_P (GLOBAL.PRSO, OList("RAISED_BASKET;LOWERED_BASKET"))) {
      msg ("The cage is securely fastened to the iron chain.")
      return (true)
    }
    return (false)
  </function>

  <function name="BAT_F" type="boolean">
    if (VERB_P(V_TELL)) {
      FWEEP (6)
      GLOBAL.P_CONT = 0
    }
    else if (VERB_P (V_TAKE) or VERB_P (V_ATTACK) or VERB_P (V_MUNG)) {
      if (EQUAL_P (LOC (GARLIC), GLOBAL.WINNER, GLOBAL.HERE)) {
        msg ("You can't reach him; he's on the ceiling.")
      }
      else {
        FLY_ME
      }
    }
  </function>

  <function name="FLY_ME">
    FWEEP (4)
    msg ("The bat grabs you by the scruff of your neck and lifts you away....")
    CRLF
    GOTO (PickOne(GLOBAL.BAT_DROPS), false)
    if (not EQUAL_P(GLOBAL.HERE, ENTRANCE_TO_HADES)) {
      V_FIRST_LOOK
    }
  </function>

  <function name="FWEEP" parameters="N"><![CDATA[
    while (N - 1 > 0) {
      N = N - 1
      msg ("&nbsp;&nbsp;&nbsp;&nbsp;Fweep!")
    }
    CRLF
  ]]></function>

  <function name="BELL_F" type="boolean">
    if (VERB_P (V_RING)) {
      if (GLOBAL.HERE = GLOBAL.LLD_ROOM and not GLOBAL.LLD_FLAG) {
        return (false)
      }
      else {
        msg ("Ding, dong.")
        return (true)
      }
    }
    return (false)
  </function>

  <function name="HOT_BELL_F" type="boolean">
    if (VERB_P (V_TAKE)) {
      msg ("The bell is very hot and cannot be taken.")
      return (true)
    }
    else if (VERB_P(V_RUB) or (VERB_P(V_RING) and not GLOBAL.PRSI = NOTHING)) {
      if (FSET_P(GLOBAL.PRSI,"BURNBIT")) {
        msg ("The " + GLOBAL.PRSI.alias + " burns and is consumed.")
        REMOVE_CAREFULLY (GLOBAL.PRSI)
      }
      else if (GLOBAL.PRSI = HANDS) {
        msg ("The bell is too hot to touch.")
      }
      else {
        msg ("The heat from the bell is too intense.")
      }
      return (true)
    }
    else if (VERB_P (V_POUR_ON)) {
      REMOVE_CAREFULLY (GLOBAL.PRSO)
      msg ("The water cools the bell and is evaporated.")
      QUEUE (I_XBH, 0)
      invoke (I_XBH.script)
      return (true)
    }
    else if (VERB_P (V_RING)) {
      msg ("The bell is too hot to reach.")
      return (true)
    }
    return (false)
  </function>

  <function name="BOARDED_WINDOW_FCN" type="boolean">
    if (VERB_P (V_OPEN)) {
      msg ("The windows are boarded and can't be opened.")
      return (true)
    }
    return (false)
  </function>

  <function name="NAILS_PSEUDO" type="boolean">
    if (VERB_P(V_TAKE)) {
      msg ("The nails, deeply imbedded in the door, cannot be removed.")
      return (true)
    }
    return (false)
  </function>

  <function name="CRACK_FCN" type="boolean">
    if (VERB_P(V_THROUGH)) {
      msg ("You can't fit through the crack.")
      return (true)
    }
    return (false)
  </function>

  <function name="KITCHEN_FCN" parameters="RARG" type="boolean">
    if (RARG = "M_LOOK") {
      TELL ("You are in the kitchen of the white house. A table seems to have been used recently for the preparation of food. A passage leads to the west and a dark staircase can be seen leading upward. A dark chimney leads down and to the east is a small window which is ")
      if (FSET_P(KITCHEN_WINDOW,"OPENBIT")) {
        msg ("open.")
      }
      else {
        msg ("slightly ajar.")
      }
      return (true)
    }
    else if (RARG = "M_BEG") {
      if (VERB_P(V_CLIMB_UP) and GLOBAL.PRSO = STAIRS) {
        DO_WALK ("UP")
        return (true)
      }
      else if (VERB_P(V_CLIMB_DOWN) and GLOBAL.PRSO = STAIRS) {
        msg ("There are no stairs leading down.")
        return (true)
      }
    }
    return (false)
  </function>

  <function name="STONE_BARROW_FCN" parameters="RARG" type="boolean"><![CDATA[
    if (RARG = "M_BEG" and (VERB_P(V_ENTER) or (VERB_P(V_WALK) and (GLOBAL.PRSO_DIR = "west" or GLOBAL.PRSO_DIR = "in")) or (VERB_P(V_THROUGH) and GLOBAL.PRSO = BARROW_DOOR))) {
      // TODO - Made the first line bold (room name)
      UpdateLocationString ("Inside the Barrow")
      JS.eval("$('#inventoryLabel,#inventoryAccordion,#placesObjectsLabel,#placesObjectsAccordion,#compassLabel,#compassAccordion').hide();")
      msg ("<b>Inside the Barrow</b><br/>As you enter the barrow, the door closes inexorably behind you. Around you it is dark, but ahead is an enormous cavern, brightly lit. Through its center runs a wide stream. Spanning the stream is a small wooden footbridge, and beyond a path leads into a dark tunnel. Above the bridge, floating in the air, is a large sign. It reads:  All ye who stand before this bridge have completed a great and perilous adventure which has tested your wit and courage. You have mastered <i>ZORK: The Great Underground Empire</i>.<br/>")
      FINISH
      return (true)
    }
    return (false)
  ]]></function>

  <function name="BARROW_DOOR_FCN" type="boolean">
    if (VERB_P(V_OPEN) or VERB_P(V_CLOSE)) {
      msg ("The door is too heavy.")
      return (true)
    }
    return (false)
  </function>

  <function name="BARROW_FCN" type="boolean">
    if (VERB_P(V_THROUGH)) {
      DO_WALK ("WEST")
      return (true)
    }
    return (false)
  </function>

  <function name="TROPHY_CASE_FCN" type="boolean">
    if (VERB_P(V_TAKE) and GLOBAL.PRSO = TROPHY_CASE) {
      msg ("The trophy case is securely fastened to the wall.")
      return (true)
    }
    return (false)
  </function>

  <function name="LIVING_ROOM_FCN" parameters="RARG" type="boolean"><![CDATA[
    dLog("[LIVING_ROOM_FCN]...")
    if (RARG = "M_LOOK") {
      TELL ("You are in the living room. There is a doorway to the east")
      if (GetBoolean(GLOBAL, "MAGIC_FLAG")) {
        TELL (". To the west is a cyclops-shaped opening in an old wooden door, above which is some strange gothic lettering, ")
      }
      else {
        TELL (", a wooden door with strange gothic lettering to the west, which appears to be nailed shut, ")
      }
      TELL ("a trophy case, ")
      if (FSET_P(RUG, "TOUCHBIT") and FSET_P(TRAP_DOOR, "OPENBIT")) {
        TELL ("and a rug lying beside an open trap door.")
      }
      else if (FSET_P(RUG, "TOUCHBIT")) {
        TELL ("and a closed trap door at your feet.")
      }
      else if (FSET_P(TRAP_DOOR, "OPENBIT")) {
        TELL ("and an open trap door at your feet.")
      }
      else {
        TELL ("and a large oriental rug in the center of the room.")
      }
      msg ("")
      return (true)
    }
    else if (RARG = "M_END") {
      if (GLOBAL.PRSA = V_TAKE or (GLOBAL.PRSA = V_PUT and GLOBAL.PRSI = TROPHY_CASE)) {
        if (TypeOf(GLOBAL.PRSO) = "objectlist") {
          foreach (o, GLOBAL.PRSO) {
            if (LOC(o) = TROPHY_CASE) {
              TOUCH_ALL (o)
            }
          }
        }
        else if (GLOBAL.PRSO <> null) {
          if (LOC(GLOBAL.PRSO) = TROPHY_CASE) {
            TOUCH_ALL (GLOBAL.PRSO)
          }
        }
      }
      GLOBAL.SCORE = GLOBAL.BASE_SCORE + OTVAL_FROB(null)
      return (SCORE_UPD (0))
    }
    return (false)
  ]]></function>

  <function name="TOUCH_ALL" parameters="OBJ">
    foreach (F, GetDirectChildren(OBJ)) {
      F.TOUCHBIT = true
      if (GetBoolean(F, "isroom")) {
        F.visited = true
      }
    }
  </function>

  <function name="OTVAL_FROB" parameters="O" type="int">
    if (not IsDefined("O")) {
      O = TROPHY_CASE
    }
    if (O = null) {
      O = TROPHY_CASE
    }
    dLog("[OTVAL_FROB] O=" + O)
    SCORE = 0
    foreach (o, GetDirectChildren(O)) {
      dLog("[OTVAL_FROB] (foreach) o="+o.name)
      if (not HasAttribute(o,"TVALUE")){
        dLog("[OTVAL_FROB] setting " + o.name + ".TVALUE to 0")
        o.TVALUE = 0
      }
      dLog("[OTVAL_FROB] " + o + ".TVALUE=" + o.TVALUE)
      SCORE = SCORE + o.TVALUE
    }
    dLog("[OTVAL_FROB] returning " + SCORE)
    return (SCORE)
  </function>

  <function name="TRAP_DOOR_FCN" type="boolean">
    if (VERB_P(V_RAISE)) {
      PERFORM (V_OPEN, TRAP_DOOR, NOTHING)
      return (true)
    }
    else if ((VERB_P(V_OPEN) or VERB_P(V_CLOSE)) and GLOBAL.HERE = LIVING_ROOM) {
      OPEN_CLOSE (GLOBAL.PRSO, "The door reluctantly opens to reveal a rickety staircase descending into darkness.", "The door swings shut and closes.")
      return (true)
    }
    else if (VERB_P(V_LOOK_UNDER) and GLOBAL.HERE = LIVING_ROOM) {
      if (FSET_P(TRAP_DOOR,"OPENBIT")) {
        msg ("You see a rickety staircase descending into darkness.")
      }
      else {
        msg ("It's closed.")
      }
      return (true)
    }
    else if (GLOBAL.HERE = CELLAR) {
      if ((VERB_P(V_OPEN) or VERB_P(V_UNLOCK)) and not FSET_P(TRAP_DOOR,"OPENBIT")) {
        FCLEAR (TRAP_DOOR, "TOUCHBIT")
        FCLEAR (TRAP_DOOR, "OPENBIT")
        msg ("The door closes and locks.")
      }
      else {
        msg (PICK_ONE(GLOBAL.DUMMY))
      }
      return (true)
    }
    return (false)
  </function>

  <function name="CELLAR_FCN" parameters="RARG" type="boolean"><![CDATA[
    if (RARG = "M_LOOK") {
      msg ("You are in a dark and damp cellar with a narrow passageway leading north, and a crawlway to the south. On the west is the bottom of a steep metal ramp which is unclimbable.")
      return (true)
    }
    else if (RARG = "M_ENTER") {
      if (FSET_P(TRAP_DOOR, "OPENBIT") and not FSET_P(TRAP_DOOR,"TOUCHBIT")) {
        FCLEAR (TRAP_DOOR, "OPENBIT")
        FSET (TRAP_DOOR, "TOUCHBIT")
        msg ("The trap door crashes shut, and you hear someone barring it.<br/>")
      }
    }
    return (false)
  ]]></function>

  <function name="CHIMNEY_F" type="boolean">
    if (VERB_P(V_EXAMINE)) {
      TELL ("The chimney leads ")
      if (GLOBAL.HERE = KITCHEN) {
        TELL ("down")
      }
      else {
        TELL ("up")
      }
      msg ("ward, and looks climbable.")
      return (true)
    }
    return (false)
  </function>

  <function name="UP_CHIMNEY_FUNCTION" type="object">
    F = FIRST_P(GLOBAL.WINNER)
    if (F = NOTHING) {
      msg ("Going up empty-handed is a bad idea.")
      return (NOTHING)
    }
    else if (NEXT_P(F) = NOTHING or (NEXT_P(NEXT_P(F)) = NOTHING) or not IN_P (LAMP, GLOBAL.WINNER)) {
      if (not FSET_P(TRAP_DOOR, "OPENBIT")) {
        FCLEAR (TRAP_DOOR, "TOUCHBIT")
      }
      return (KITCHEN)
    }
    else {
      msg ("You can't get up there with what you're carrying.")
      return (NOTHING)
    }
  </function>

  <function name="TRAP_DOOR_EXIT" type="object">
    if (GLOBAL.RUG_MOVED) {
      if (FSET_P(TRAP_DOOR,"OPENBIT")) {
        return (CELLAR)
      }
      else {
        msg ("The trap door is closed.")
        return (NOTHING)
      }
    }
    else {
      msg ("You can't go that way.")
      return (NOTHING)
    }
  </function>

  <function name="RUG_FCN" type="boolean">
    dLog("[RUG_FCN]...")
    if (VERB_P(V_RAISE)) {
      TELL ("The rug is too heavy to lift")
      if (GLOBAL.RUG_MOVED) {
        msg (".")
      }
      else {
        msg (", but in trying to take it you have noticed an irregularity beneath it.")
      }
      return (true)
    }
    else if (VERB_P("MOVE PUSH")) {
      if (GLOBAL.RUG_MOVED) {
        msg ("Having moved the carpet previously, you find it impossible to move it again.")
      }
      else {
        msg ("With a great effort, the rug is moved to one side of the room, revealing the dusty cover of a closed trap door.")
        FCLEAR (TRAP_DOOR, "INVISIBLE")
        THIS_IS_IT (TRAP_DOOR)
        GLOBAL.RUG_MOVED = true
      }
      return (true)
    }
    else if (VERB_P(V_TAKE)) {
      msg ("The rug is extremely heavy and cannot be carried.")
      return (true)
    }
    else if (VERB_P(V_LOOK_UNDER)) {
      if (not GLOBAL.RUG_MOVED and not FSET_P(TRAP_DOOR, "OPENBIT")) {
        msg ("As you sit, you notice an irregularity underneath it. Rather than be uncomfortable, you stand up again.")
        return (true)
      }
      else {
        msg ("I suppose you think it's a magic carpet?")
        return (true)
      }
    }
    return (false)
  </function>

  <function name="AXE_F" type="boolean">
    if (GLOBAL.TROLL_FLAG) {
      // do nothing?
    }
    else {
      WEAPON_FUNCTION (STILETTO, THIEF)
      return (true)
    }
    return (false)
  </function>

  <function name="STILETTO_FUNCTION" type="boolean">
    WEAPON_FUNCTION (STILETTO, THIEF)
    return (true)
  </function>

  <function name="WEAPON_FUNCTION" parameters="W, V" type="boolean">
    if (not IN_P (V, GLOBAL.HERE)) {
      return (false)
    }
    else if (VERB_P (V_TAKE)) {
      if (IN_P (W, V)) {
        msg ("The " + V.alias + " swings it out of your reach.")
      }
      else {
        msg ("The " + W.alias + " seems white-hot. You can't hold on to it.")
      }
      return (true)
    }
    return (false)
  </function>

  <function name="TROLL_FCN" parameters="MODE" type="boolean">
    if (not IsDefined("MODE")) {
      MODE = 0
    }
    if (TypeOf(MODE) = "int"){
      // do nothing
    }
    else {
      if (IsInt(MODE)) MODE = ToInt(MODE)
      else MODE = 0
    }
    dLog("[TROLL_FCN] MODE = " + MODE)
    if (VERB_P(V_TELL)) {
      GLOBAL.P_CONT = 0
      msg ("The troll isn't much of a conversationalist.")
      return (true)
    }
    else if (MODE = GLOBAL.F_BUSY_P) { //1
      if (IN_P(AXE,TROLL)) {
        // do nothing?
      }
      else if (IN_P(AXE,GLOBAL.HERE) and PROB(75,90)) {
        FSET (AXE, "NDESCBIT")
        FCLEAR (AXE, "WEAPONBIT")
        MOVE (AXE, TROLL)
        TROLL.LDESC = "A nasty-looking troll, brandishing a bloody axe, blocks all passages out of the room."
        if (IN_P(TROLL, GLOBAL.HERE)) {
          msg ("The troll, angered and humiliated, recovers his weapon. He appears to have an axe to grind with you.")
        }
        return (true)
      }
      else if (IN_P(TROLL.GLOBAL.HERE)) {
        TROLL.LDESC = "A pathetically babbling troll is here."
        msg ("The troll, disarmed, cowers in terror, pleading for his life in the guttural tongue of the trolls.")
        return (true)
      }
    }
    else if (MODE = GLOBAL.F_DEAD) { //2
      dLog("[TROLL_FCN] MODE = F_DEAD")
      if (IN_P(AXE,TROLL)) {
        MOVE (AXE, GLOBAL.HERE)
        FCLEAR (AXE, "NDESCBIT")
        FSET (AXE, "WEAPONBIT")
      }
      GLOBAL.TROLL_FLAG = true
    }
    else if (MODE = GLOBAL.F_UNCONSCIOUS) { //3
      dLog("[TROLL_FCN] MODE = F_UNCONSCIOUS")
      FCLEAR (TROLL, "FIGHTBIT")
      if (IN_P(AXE,TROLL)) {
        MOVE (AXE, GLOBAL.HERE)
        FCLEAR (AXE, "NDESCBIT")
        FSET (AXE, "WEAPONBIT")
      }
      TROLL.LDESC = "An unconscious troll is sprawled on the floor. All passages out of the room are open."
      GLOBAL.TROLL_FLAG = true
    }
    else if (MODE = GLOBAL.F_CONSCIOUS) { //4
      dLog("[TROLL_FCN] MODE = F_CONSCIOUS")
      if (IN_P(TROLL, GLOBAL.HERE)) {
        FSET (TROLL, "FIGHTBIT")
        msg ("The troll stirs, quickly resuming a fighting stance.")
      }
      if (IN_P(AXE,TROLL)) {
        TROLL.LDESC = "A nasty-looking troll, brandishing a bloody axe, blocks all passages out of the room."
      }
      else if (IN_P(AXE,TROLL_ROOM)) {
        FSET (AXE, "NDESCBIT")
        FCLEAR (AXE, "WEAPONBIT")
        MOVE (AXE, TROLL)
        TROLL.LDESC = "A nasty-looking troll, brandishing a bloody axe, blocks all passages out of the room."
      }
      else {
        TROLL.LDESC = "A troll is here."
      }
      GLOBAL.TROLL_FLAG = false
    }
    else if (MODE = GLOBAL.F_FIRST_P) { //5
      dLog("[TROLL_FCN] MODE = F_FIRST_P")
      if (PROB(33)) {
        FSET (TROLL, "FIGHTBIT")
        GLOBAL.P_CONT = 0
      }
    }
    else if (MODE = 0) {
      if (VERB_P(V_EXAMINE)) {
        msg (TROLL.LDESC)
        return (true)
      }
      else if (((VERB_P(V_THROW) or VERB_P(V_GIVE)) and (not GLOBAL.PRSO = NOTHING) and GLOBAL.PRSI = TROLL) or (VERB_P(V_TAKE) or VERB_P(V_MOVE) or VERB_P(V_MUNG))) {
        AWAKEN (TROLL)
        if (VERB_P(V_THROW) or VERB_P(V_GIVE)) {
          if (GLOBAL.PRSO = AXE and IN_P(AXE,GLOBAL.WINNER)) {
            msg ("The troll scratches his head in confusion, then takes the axe.")
            FSET (TROLL, "FIGHTBIT")
            MOVE (AXE, TROLL)
            return (true)
          }
          else if (GLOBAL.PRSO = TROLL or GLOBAL.PRSO = AXE) {
            msg ("You would have to get the " + GLOBAL.PRSO.alias + " first, and that seems unlikely.")
            return (true)
          }
          if (VERB_P(V_THROW)) {
            TELL ("The troll, who is remarkably coordinated, catches the " + GLOBAL.PRSO.alias)
          }
          else {
            TELL ("The troll, who is not overly proud, graciously accepts the gift")
          }
          if (PROB(20) and EQUAL_P(GLOBAL.PRSO.name, Split("KNIFE;SWORD;AXE"))) {
            REMOVE_CAREFULLY (GLOBAL.PRSO)
            msg (" and eats it hungrily. Poor troll, he dies from an internal hemorrhage and his carcass disappears in a sinister black fog.")
            REMOVE_CAREFULLY (TROLL)
            dLog("[TROLL_FCN] MODE = F_DEAD")
            unused = Eval(TROLL.ACTION + "(GLOBAL.F_DEAD)")
            GLOBAL.TROLL_FLAG = true
          }
          else if (EQUAL_P(GLOBAL.PRSO.name, Split("KNIFE;SWORD;AXE"))) {
            MOVE (GLOBAL.PRSO, GLOBAL.HERE)
            msg (" and, being for the moment sated, throws it back. Fortunately, the troll has poor control, and the " + GLOBAL.PRSO.alias + " falls to the floor. He does not look pleased.")
            FSET (TROLL, "FIGHTBIT")
          }
          else {
            msg (" and not having the most discriminating tastes, gleefully eats it.")
            REMOVE_CAREFULLY (GLOBAL.PRSO)
          }
          return (true)
        }
        else if (VERB_P(V_TAKE) or VERB_P(V_MOVE)) {
          msg ("The troll spits in your face, grunting \"Better luck next time\" in a rather barbarous accent.")
          return (true)
        }
        else if (VERB_P(V_MUNG)) {
          msg ("The troll laughs at your puny gesture.")
          return (true)
        }
      }
    }
    dLog("[TROLL_FCN] ends; returning false")
    return (false)
  </function>

  <function name="LEAVES_APPEAR">
    if (not FSET_P (GRATE, "OPENBIT") and not GetBoolean(GLOBAL, "GRATE_REVEALED")) {
      if (VERB_P(V_MOVE) or VERB_P(V_TAKE)) {
        msg ("In disturbing the pile of leaves, a grating is revealed.")
      }
      else {
        msg ("With the leaves moved, a grating is revealed.")
      }
      FCLEAR (GRATE, "INVISIBLE")
      GLOBAL.GRATE_REVEALED = true
    }
    return (false)
  </function>

  <function name="LEAF_PILE" type="boolean">
    if (VERB_P (V_COUNT)) {
      msg ("There are 69,105 leaves here.")
      return (true)
    }
    else if (VERB_P (V_BURN)) {
      LEAVES_APPEAR
      REMOVE_CAREFULLY (GLOBAL.PRSO)
      if (IN_P (GLOBAL.PRSO, GLOBAL.HERE)) {
        msg ("The leaves burn.")
      }
      else {
        msg ("The leaves burn, and so do you.")
      }
      return (true)
    }
    else if (VERB_P (V_CUT)) {
      msg ("You rustle the leaves around, making quite a mess.")
      LEAVES_APPEAR
      return (true)
      return (true)
    }
    else if (VERB_P (V_MOVE) or VERB_P (V_TAKE)) {
      if (VERB_P (V_MOVE)) {
        msg ("Done.")
        return (true)
      }
      if (GetBoolean(GLOBAL,"GRATE_REVEALED")) {
        return (false)
      }
      LEAVES_APPEAR
      if (VERB_P (V_TAKE)) {
        return (false)
      }
      else {
        return (true)
      }
    }
    else if (VERB_P (V_LOOK_UNDER) and not GLOBAL.GRATE_REVEALED) {
      msg ("Underneath the pile of leaves is a grating. As you release the leaves, the grating is once again concealed from view.")
      return (true)
    }
    return (false)
  </function>

  <function name="CLEARING_FCN" parameters="RARG" type="boolean">
    if (RARG = "M_ENTER") {
      if (not GetBoolean(GLOBAL, "GRATE_REVEALED")) {
        FSET (GRATE, "INVISIBLE")
      }
    }
    else if (RARG = "M_LOOK") {
      TELL ("You are in a clearing, with a forest surrounding you on all sides. A path leads south.")
      if (FSET_P(GRATE,"OPENBIT")) {
        CRLF
        TELL ("There is a grating securely fastened into the ground.")
      }
      CRLF
      return (true)
    }
    return (false)
  </function>

  <function name="MAZE_11_FCN" parameters="RARG" type="boolean">
    if (RARG = "M_ENTER") {
      FCLEAR (GRATE, "INVISIBLE")
    }
    else if (RARG = "M_LOOK") {
      msg ("You are in a small room near the maze. There are twisty passages in the immediate vicinity.")
      if (FSET_P(GRATE,"OPENBIT")) {
        TELL ("Above you is an open grating with sunlight pouring in.")
      }
      else if (GetBoolean(GLOBAL,"GRUNLOCK")) {
        TELL ("Above you is a grating.")
      }
      else {
        TELL ("Above you is a grating locked with a skull-and-crossbones lock.")
      }
      CRLF
      return (true)
    }
    return (false)
  </function>

  <function name="GRATE_FUNCTION" type="boolean">
    if (VERB_P(V_OPEN) and GLOBAL.PRSI = KEYS) {
      PERFORM (V_UNLOCK, GRATE, KEYS)
      return (true)
    }
    else if (VERB_P(V_LOCK)) {
      if (GLOBAL.HERE = GRATING_ROOM) {
        GLOBAL.GRUNLOCK = false
        msg ("The grate is locked.")
        return (true)
      }
      else if (GLOBAL.HERE = GRATING_CLEARING) {
        msg ("You can't lock it from this side.")
        return (true)
      }
    }
    else if (VERB_P (V_UNLOCK) and GLOBAL.PRSO = GRATE) {
      if (GLOBAL.HERE = GRATING_ROOM and GLOBAL.PRSI = KEYS) {
        GLOBAL.GRUNLOCK = true
        msg ("The grate is unlocked.")
        return (true)
      }
      else if (GLOBAL.HERE = GRATING_CLEARING and GLOBAL.PRSI = KEYS) {
        msg ("You can't reach the lock from here.")
        return (true)
      }
      else {
        msg ("Can you unlock a grating with a " + GLOBAL.PRSI.alias + "?")
        return (true)
      }
    }
    else if (VERB_P(V_PICK)) {
      msg ("You can't pick the lock.")
      return (true)
    }
    else if (VERB_P(V_OPEN) or VERB_P(V_CLOSE)) {
      if (GetBoolean(GLOBAL, "GRUNLOCK")) {
        if (GLOBAL.HERE = CLEARING) {
          opnstr = "The grating opens"
        }
        else {
          opnstr = "The grating opens to reveal trees above you."
        }
        OPEN_CLOSE (GRATE, openstr, "The grating is closed.")
        if (FSET_P(GRATE,"OPENBIT")) {
          if (not GLOBAL.HERE = CLEARING and not GetBoolean(GLOBAL,"GRATE_REVEALED")) {
            msg ("A pile of leaves falls onto your head and to the ground.")
            GLOBAL.GRATE_REVEALED = true
            MOVE (LEAVES, HERE)
          }
          FSET (GRATING_ROOM, "ONBIT")
        }
        else {
          FCLEAR (GRATING_ROOM, "ONBIT")
        }
        return (true)
      }
      else {
        msg ("The grating is locked.")
        return (true)
      }
    }
    else if (VERB_P(V_PUT) and GLOBAL.PRSI = GRATE) {
      if (G_P(GLOBAL.PRSO.P_P_SIZE,20)) {
        msg ("It won't fit through the grating.")
        return (true)
      }
      else {
        MOVE (GLOBAL.PRSO, GRATING_ROOM)
        msg ("The " + GLOBAL.PRSO.alias + " goes through the grating into the darkness below.")
        return (true)
      }
    }
    return (false)
  </function>

  <function name="MAZE_DIODES" type="object"><![CDATA[
    TELL ("You won't be able to get back up to the tunnel you are going through when it gets to the next room.<br/><br/>")
    switch (GLOBAL.HERE) {
      case (MAZE_2) {
        return (MAZE_4)
      }
      case (MAZE_7) {
        return (DEAD_END_1)
      }
      case (MAZE_9) {
        return (MAZE_11)
      }
      case (MAZE_12) {
        return (MAZE_5)
      }
    }
  ]]></function>

  <function name="RUSTY_KNIFE_FCN" type="boolean">
    if (VERB_P(V_TAKE) and IN_P(SWORD,GLOBAL.WINNER)) {
      msg ("As you touch the rusty knife, your sword gives a single pulse of blinding blue light.")
      return (true)
    }
    else if ((GLOBAL.PRSI = RUSTY_KNIFE and VERB_P(V_ATTACK)) or (VERB_P(V_SWING) and GLOBAL.PRSO = RUSTY_KNIFE and not GLOBAL.PRSI = NOTHING)) {
      REMOVE_CAREFULLY (RUSTY_KNIFE)
      JIGS_UP ("As the knife approaches its victim, your mind is submerged by an overmastering will. Slowly, your hand turns, until the rusty blade is an inch from your neck. The knife seems to sing as it savagely slits your throat.")
      return (true)
    }
    return (false)
  </function>

  <function name="KNIFE_F" type="boolean">
    if (VERB_P(V_TAKE)) {
      FCLEAR (ATTIC_TABLE, "NDESCBIT")
      return (false)
    }
    return (false)
  </function>

  <function name="SKELETON" type="boolean">
    switch (GLOBAL.PRSA) {
      case (V_TAKE,V_RUB,V_MOVE,V_PUSH,V_RAISE,V_LOWER,V_ATTACK,V_KICK,V_KISS) {
        msg ("A ghost appears in the room and is appalled at your desecration of the remains of a fellow adventurer. He casts a curse on your valuables and banishes them to the Land of the Living Dead. The ghost leaves, muttering obscenities.")
        ROB (GLOBAL.HERE, LAND_OF_THE_LIVING_DEAD, 100)
        ROB (ADVENTURER, LAND_OF_THE_LIVING_DEAD)
        return (true)
      }
    }
    return (false)
  </function>

  <function name="TORCH_OBJECT" type="boolean">
    if (VERB_P(V_EXAMINE)) {
      msg ("The torch is burning.")
      return (true)
    }
    else if (VERB_P(V_POUR_ON) and GLOBAL.PRSI = TORCH) {
      msg ("The water evaporates before it gets close.")
      return (true)
    }
    else if (VERB_P(V_LAMP_OFF) and FSET_P(GLOBAL.PRSO, "ONBIT")) {
      msg ("You nearly burn your hand trying to extinguish the flame.")
      return (true)
    }
    return (false)
  </function>

  <function name="MIRROR_ROOM" parameters="RARG" type="boolean">
    if (RARG = "M_LOOK") {
      msg ("You are in a large square room with tall ceilings. On the south wall is an enormous mirror which fills the entire wall. There are exits on the other three sides of the room.")
      if (GetBoolean(GLOBAL,"MIRROR_MUNG")) {
        msg ("Unfortunately, the mirror has been destroyed by your recklessness.")
      }
      return (true)
    }
    return (false)
  </function>

  <function name="MIRROR_MIRROR" type="boolean">
    RM2 = MIRROR_ROOM_2
    if (not GetBoolean(GLOBAL,"MIRROR_MUNG") and VERB_P(V_RUB)) {
      if (not GLOBAL.PRSI = NOTHING and not GLOBAL.PRSI = HANDS) {
        msg ("You feel a faint tingling transmitted through the " + GLOBAL.PRSI.alias + ".")
        return (true)
      }
      if (GLOBAL.HERE = RM2) {
        RM2 = MIRROR_ROOM_1
      }
      foreach (o, GetDirectChildren(GLOBAL.HERE)) {
        if (not o = GLOBAL.WINNER) {
          MOVE (o, RM2)
        }
      }
      foreach (o, GetDirectChildren(RM2)) {
        if (not o = GLOBAL.WINNER) {
          MOVE (o, GLOBAL.HERE)
        }
      }
      GOTO (RM2, false)
      msg ("There is a rumble from deep within the earth and the room shakes.")
      return (true)
    }
    else if (VERB_P(V_LOOK_INSIDE) or VERB_P(V_EXAMINE)) {
      if (GetBoolean(GLOBAL,"MIRROR_MUNG")) {
        msg ("The mirror is broken into many pieces.")
      }
      else {
        msg ("There is an ugly person staring back at you.")
      }
      return (true)
    }
    else if (VERB_P(V_TAKE)) {
      msg ("The mirror is many times your size. Give up.")
      return (true)
    }
    else if (VERB_P(V_MUNG) or VERB_P(V_THROW) or VERB_P(V_ATTACK)) {
      if (GetBoolean(GLOBAL,"MIRROR_MUNG")) {
        msg ("Haven't you done enough damage already?")
      }
      else {
        GLOBAL.MIRROR_MUNG = true
        GLOBAL.LUCKY = false
        msg ("You have broken the mirror. I hope you have a seven years' supply of good luck handy.")
      }
      return (true)
    }
    return (false)
  </function>

  <function name="OPENABLE_P" parameters="o" type="boolean">
    return (FSET_P(o,"CONTBIT") or FSET_P(o,"DOORBIT"))
  </function>

  <function name="CONTAINS_WITHIN" parameters="obj1, obj2" type="boolean">
    return (ListContains(ListParents(obj1),obj2))
  </function>

  <function name="TORCH_ROOM_FCN" parameters="RARG" type="boolean">
    if (RARG = "M_LOOK") {
      msg ("This is a large room with a prominent doorway leading to a down staircase. Above you is a large dome. Up around the edge of the dome (20 feet up) is a wooden railing. In the center of the room sits a white marble pedestal.")
      if (GetBoolean(GLOBAL,"DOME_FLAG")) {
        msg ("A piece of rope descends from the railing above, ending some five feet above your head.")
      }
      return (true)
    }
    return (false)
  </function>

  <function name="DOME_ROOM_FCN" parameters="RARG" type="boolean">
    if (RARG = "M_LOOK") {
      msg ("You are at the periphery of a large dome, which forms the ceiling of another room below. Protecting you from a precipitous drop is a wooden railing which circles the dome.")
      if (GetBoolean(GLOBAL,"DOME_FLAG")) {
        msg ("Hanging down from the railing is a rope which ends about ten feet from the floor below.")
      }
      return (true)
    }
    else if (RARG = "M_ENTER") {
      if (GetBoolean(GLOBAL,"DEAD")) {
        msg ("As you enter the dome you feel a strong pull as if from a wind drawing you over the railing and down.")
        MOVE (GLOBAL.WINNER, TORCH_ROOM)
        return (true)
      }
      else if (VERB_P(V_LEAP)) {
        JIGS_UP ("I'm afraid that the leap you attempted has done you in.")
        return (true)
      }
    }
    return (false)
  </function>

  <function name="LLD_ROOM" parameters="RARG" type="boolean"><![CDATA[
    dLog("[LLD_ROOM]...")
    if (RARG = "M_LOOK") {
      msg ("You are outside a large gateway, on which is inscribed<br/>")
      msg ("{=Spaces(2)}Abandon every hope all ye who enter here!<br/>")
      msg ("The gate is open; through it you can see a desolation, with a pile of mangled bodies in one corner. Thousands of voices, lamenting some hideous fate, can be heard.")
      if (not GetBoolean(GLOBAL,"LLD_FLAG") and not GetBoolean(GLOBAL,"DEAD")) {
        msg ("The way through the gate is barred by evil spirits, who jeer at your attempts to pass.")
      }
      return (true)
    }
    else if (RARG = "M_BEG") {
      dLog("[LLD_ROOM] M_BEG...")
      if (VERB_P(V_EXORCISE)) {
        if (not GetBoolean(GLOBAL,"LLD_FLAG")) {
          if (IN_P(BELL,GLOBAL.WINNER) and IN_P(BOOK,GLOBAL.WINNER) and IN_P(CANDLES,GLOBAL.WINNER)) {
            msg ("You must perform the ceremony.")
          }
          else {
            msg ("You aren't equipped for an exorcism.")
          }
          return (true)
        }
      }
      else if (not GetBoolean(GLOBAL,"LLD_FLAG") and VERB_P(V_RING) and GLOBAL.PRSO = BELL) {
        GLOBAL.XB = true
        REMOVE_CAREFULLY (BELL)
        THIS_IS_IT (HOT_BELL)
        MOVE (HOT_BELL, GLOBAL.HERE)
        msg ("The bell suddenly becomes red hot and falls to the ground. The wraiths, as if paralyzed, stop their jeering and slowly turn to face you. On their ashen faces, the expression of a long-forgotten terror takes shape.")
        if (IN_P(CANDLES,GLOBAL.WINNER)) {
          msg ("In your confusion, the candles drop to the ground (and they are out).")
          MOVE (CANDLES, GLOBAL.HERE)
          FCLEAR (CANDLES, "ONBIT")
          I_CANDLES.enabled = false
        }
        ENABLE (QUEUE(I_XB, 6))
        ENABLE (QUEUE(I_XBH, 20))
        return (true)
      }
      else if (GetBoolean(GLOBAL,"XC") and VERB_P(V_READ) and GLOBAL.PRSO = BOOK and not GetBoolean(GLOBAL,"LLD_FLAG")) {
        msg ("Each word of the prayer reverberates through the hall in a deafening confusion. As the last word fades, a voice, loud and commanding, speaks: \"Begone, fiends!\" A heart-stopping scream fills the cavern, and the spirits, sensing a greater power, flee through the walls")
        REMOVE_CAREFULLY (GHOSTS)
        GLOBAL.LLD_FLAG = true
        DISABLE (I_XC)
        return (true)
      }
    }
    else if (RARG = "M_END") {
      dLog("[LLD_ROOM] M_END")
      if (GetBoolean(GLOBAL,"XB") and IN_P(CANDLES,GLOBAL.WINNER) and FSET_P(CANDLES,"ONBIT") and not GetBoolean(GLOBAL,"XC")) {
        GLOBAL.XC = true
        msg ("The flames flicker wildly and appear to dance. The earth beneath your feet trembles, and your legs nearly buckle beneath you. The spirits cower at your unearthly power.")
        DISABLE (I_XB)
        ENABLE (QUEUE(I_XC, 4))
        //return (true)
      }
    }
    dLog("[LLD_ROOM] ends")
    return (false)
  ]]></function>

<!--

-->

  <turnscript name="I_XB">
    <script>
      if (GetBoolean(GLOBAL,"XC") or GLOBAL.HERE = ENTRANCE_TO_HADES) {
        if (GLOBAL.HERE = ENTRANCE_TO_HADES) {
          msg ("The tension of this ceremony is broken, and the wraiths, amused but shaken at your clumsy attempt, resume their hideous jeering.")
        }
        GLOBAL.XB = false
      }
    </script>
  </turnscript>

  <turnscript name="I_XC">
    <script>
      GLOBAL.XC = false
      invoke (I_XB.script)
    </script>
  </turnscript>

  <turnscript name="I_XBH">
    <script>
      REMOVE_CAREFULLY (HOT_BELL)
      MOVE (BELL, ENTRANCE_TO_HADES)
      if (GLOBAL.HERE = ENTRANCE_TO_HADES) {
        msg ("The bell appears to have cooled down.")
      }
    </script>
  </turnscript>
  
<!--
"SUBTITLE FLOOD CONTROL DAM #3"
-->

  <function name="DAM_ROOM_FCN" parameters="RARG" type="boolean">
    if (RARG = "M_LOOK") {
      msg ("You are standing on the top of the Flood Control Dam #3, which was quite a tourist attraction in times far distant. There are paths to the north, south, and west, and a scramble down.")
      if (GetBoolean(GLOBAL,"LOW_TIDE") and GetBoolean(GLOBAL,"GATES_OPEN")) {
        msg ("The water level behind the dam is low: The sluice gates have been opened. Water rushes through the dam and downstream.")
      }
      else if (GetBoolean(GLOBAL,"GATES_OPEN")) {
        msg ("The sluice gates are open, and water rushes through the dam. The water level behind the dam is still high.")
      }
      else if (GetBoolean(GLOBAL,"LOW_TIDE")) {
        msg ("The sluice gates are closed. The water level in the reservoir is quite low, but the level is rising quickly.")
      }
      else {
        msg ("The sluice gates on the dam are closed. Behind the dam, there can be seen a wide reservoir. Water is pouring over the top of the now abandoned dam.")
      }
      TELL ("There is a control panel here, on which a large metal bolt is mounted. Directly above the bolt is a small green plastic bubble")
      if (GetBoolean(GLOBAL,"GATE_FLAG")) {
        TELL (" which is glowing serenely")
      }
      msg (".")
      return (true)
    }
    return (false)
  </function>

  <function name="BOLT_F" type="boolean">
    if (VERB_P(V_TURN)) {
      if (GLOBAL.PRSI = WRENCH) {
        if (GetBoolean(GLOBAL,"GATE_FLAG")) {
          FCLEAR (RESERVOIR_SOUTH, "TOUCHBIT")
          if (GetBoolean(GLOBAL,"GATES_OPEN")) {
            GLOBAL.GATES_OPEN = false
            FCLEAR (LOUD_ROOM, "TOUCHBIT")
            msg ("The sluice gates close and water starts to collect behind the dam.")
            ENABLE (QUEUE(I_RFILL, 8))
            QUEUE (I_REMPTY, 0)
            return (true)
          }
          else {
            GLOBAL.GATES_OPEN = true
            msg ("The sluice gates open and water pours through the dam.")
            ENABLE (QUEUE(I_REMPTY, 8))
            QUEUE (I_RFILL, 0)
            return (true)
          }
        }
        else {
          msg ("The bolt won't turn using the " + GLOBAL.PRSI.alias + ".")
          return (true)
        }
      }
    }
    else if (VERB_P(V_TAKE)) {
      INTEGRAL_PART
      return (true)
    }
    else if (VERB_P(V_OIL)) {
      msg ("Hmm. It appears the tube contained glue, not oil. Turning the bolt won't get any easier....")
      return (true)
    }
    return (false)
  </function>

  <function name="BUBBLE_F" type="boolean">
    if (VERB_P(V_TAKE)) {
      INTEGRAL_PART
      return (true)
    }
    return (false)
  </function>

  <function name="INTEGRAL_PART">
    msg ("It is an integral part of the control panel.")
  </function>

  <turnscript name="I_RFILL">
    <script>
      FSET (RESERVOIR, "NONLANDBIT")
      FCLEAR (RESERVOIR, "RLANDBIT")
      FCLEAR (DEEP_CANYON, "TOUCHBIT")
      FCLEAR (LOUD_ROOM, "TOUCHBIT")
      if (IN_P(TRUNK,RESERVOIR)) {
        FSET (TRUNK, "INVISIBLE")
        TRUNK.visible = false
      }
      GLOBAL.LOW_TIDE = false
      if (GLOBAL.HERE = RESERVOIR) {
        if (FSET_P(LOC(GLOBAL.WINNER),"VEHBIT")) {
          msg ("The boat lifts gently out of the mud and is now floating on the reservoir.")
        }
        else {
          JIGS_UP ("You are lifted up by the rising river! You try to swim, but the currents are too strong. You come closer, closer to the awesome structure of Flood Control Dam #3. The dam beckons to you. The roar of the water nearly deafens you, but you remain conscious as you tumble over the dam toward your certain doom among the rocks at its base.")
        }
      }
      else if (GLOBAL.HERE = DEEP_CANYON) {
        msg ("A sound, like that of flowing water, starts to come from below.")
      }
      else if (GLOBAL.HERE = LOUD_ROOM) {
        dLog("[I_RFILL] Moving player from Loud Room to random from LOUD_RUNS")
        msg ("All of a sudden, an alarmingly loud roaring sound fills the room. Filled with fear, you scramble away.")
        GOTO (PICK_ONE_OBJECT(GLOBAL.LOUD_RUNS), true)
      }
      else if (GLOBAL.HERE = RESERVOIR_NORTH or GLOBAL.HERE = RESERVOIR_SOUTH) {
        msg ("You notice that the water level has risen to the point that it is impossible to cross.")
      }
    </script>
  </turnscript>

<!--

-->

  <turnscript name="I_REMPTY">
    <script>
      FSET (RESERVOIR, "RLANDBIT")
      FCLEAR (RESERVOIR, "NONLANDBIT")
      FCLEAR (DEEP_CANYON, "TOUCHBIT")
      FCLEAR (LOUD_ROOM, "TOUCHBIT")
      FCLEAR (TRUNK, "INVISIBLE")
      TRUNK.visible = true
      GLOBAL.LOW_TIDE = true
      if (GLOBAL.HERE = RESERVOIR and FSET_P(LOC(GLOBAL.WINNER),"VEHBIT")) {
        msg ("The water level has dropped to the point at which the boat can no longer stay afloat. It sinks into the mud.")
      }
      else if (GLOBAL.HERE = DEEP_CANYON) {
        msg ("The roar of rushing water is quieter now.")
      }
      else if (GLOBAL.HERE = RESERVOIR_NORTH or GLOBAL.HERE = RESERVOIR_SOUTH) {
        msg ("The water level is now quite low here and you could easily cross over to the other side.")
      }
    </script>
  </turnscript>

  <function name="BUTTON_F" type="boolean">
    if (VERB_P(V_READ)) {
      msg ("They're greek to you.")
      return (true)
    }
    else if (VERB_P(V_PUSH)) {
      if (GLOBAL.PRSO = BLUE_BUTTON) {
        if (GLOBAL.WATER_LEVEL = 0) {
          FCLEAR (LEAK, "INVISIBLE")
          msg ("There is a rumbling sound and a stream of water appears to burst from the east wall of the room (apparently, a leak has occurred in a pipe).")
          GLOBAL.WATER_LEVEL = 1
          ENABLE (QUEUE (I_MAINT_ROOM, -1))
        }
        else {
          msg ("The blue button appears to be jammed.")
        }
        return (true)
      }
      else if (GLOBAL.PRSO = RED_BUTTON) {
        TELL ("The lights within the room ")
        if (FSET_P(GLOBAL.HERE,"ONBIT")) {
          FCLEAR (GLOBAL.HERE, "ONBIT")
          msg ("shut off.")
        }
        else {
          FSET (GLOBAL.HERE, "ONBIT")
          msg ("come on.")
        }
        return (true)
      }
      else if (GLOBAL.PRSO = BROWN_BUTTON) {
        FCLEAR (DAM_ROOM, "TOUCHBIT")
        GLOBAL.GATE_FLAG = false
        msg ("Click.")
        return (true)
      }
      else if (GLOBAL.PRSO = YELLOW_BUTTON) {
        FCLEAR (DAM_ROOM, "TOUCHBIT")
        GLOBAL.GATE_FLAG = true
        msg ("Click.")
        return (true)
      }
    }
    return (false)
  </function>

  <function name="TOOL_CHEST_FCN" type="boolean">
    if (VERB_P(V_EXAMINE)) {
      msg ("The chests are all empty.")
      return (true)
    }
    else if (VERB_P(V_TAKE) or VERB_P(V_OPEN) or VERB_P(V_PUT)) {
      REMOVE_CAREFULLY (TOOL_CHEST)
      msg ("The chests are so rusty and corroded that they crumble when you touch them.")
      return (true)
    }
    else if (VERB_P(V_OPEN)) {
      msg ("The chests are already open.")
      return (true)
    }
    return (false)
  </function>

  <turnscript name="I_MAINT_ROOM">
    <script>
      HERE_P = false
      if (GLOBAL.HERE = MAINTENANCE_ROOM) {
        HERE_P = true
      }
      if (HERE_P) {
        msg ("The water level here is now " + StringListItem(GLOBAL.DROWNINGS,GLOBAL.WATER_LEVEL/2))
      }
      GLOBAL.WATER_LEVEL = GLOBAL.WATER_LEVEL + 1
      if (not L_P(GLOBAL.WATER_LEVEL,14)) {
        MUNG_ROOM (MAINTENANCE_ROOM, "The room is full of water and cannot be entered.")
        QUEUE (I_MAINT_ROOM, 0)
        if (HERE_P) {
          JIGS_UP ("I'm afraid you have done drowned yourself.")
        }
      }
      else if (IN_P(GLOBAL.WINNER,INFLATED_BOAT) and (GLOBAL.HERE = MAINTENANCE_ROOM or GLOBAL.HERE = DAM_ROOM or GLOBAL.HERE = DAM_LOBBY)) {
        JIGS_UP ("The rising water carries the boat over the dam, down the river, and over the falls. Tsk, tsk.")
      }
      return (true)
    </script>
  </turnscript>

  <function name="LEAK_FUNCTION">
    if (G_P(GLOBAL.WATER_LEVEL,0)) {
      if ((VERB_P(V_PUT) or VERB_P(V_PUT_ON)) and GLOBAL.PRSO = PUTTY) {
        FIX_MAINT_LEAK
      }
      else if (VERB_P(V_PLUG)) {
        if (GLOBAL.PRSI = PUTTY) {
          FIX_MAINT_LEAK
        }
        else {
          WITH_TELL (GLOBAL.PRSI)
        }
      }
    }
  </function>

  <function name="FIX_MAINT_LEAK">
    GLOBAL.WATER_LEVEL = -1
    QUEUE (I_MAINT_ROOM, 0)
    msg ("By some miracle of Zorkian technology, you have managed to stop the leak in the dam.")
  </function>

  <function name="PUTTY_FCN" type="boolean">
    if ((VERB_P(V_OIL) and GLOBAL.PRSI = PUTTY) or (VERB_P(V_PUT) and GLOBAL.PRSO = PUTTY)) {
      msg ("The all-purpose gunk isn't a lubricant.")
      return (true)
    }
    return (false)
  </function>

  <function name="TUBE_FUNCTION" type="boolean">
    if (VERB_P(V_PUT) and GLOBAL.PRSI = TUBE) {
      msg ("The tube refuses to accept anything.")
      return (true)
    }
    else if (VERB_P(V_SQUEEZE)) {
      if (FSET_P(GLOBAL.PRSO,"OPENBIT") and IN_P(PUTTY,GLOBAL.PRSO)) {
        MOVE (PUTTY, GLOBAL.WINNER)
        msg ("The viscous material oozes into your hand.")
      }
      else if (FSET_P(GLOBAL.PRSO,"OPENBIT")) {
        msg ("The tube is apparently empty.")
      }
      else {
        msg ("The tube is closed.")
      }
      return (true)
    }
    return (false)
  </function>

  <function name="DAM_FUNCTION" type="boolean">
    if (VERB_P(V_OPEN) or VERB_P(V_CLOSE)) {
      msg ("Sounds reasonable, but this isn't how.")
      return (true)
    }
    else if (VERB_P(V_PLUG)) {
      if (GLOBAL.PRSI = HANDS) {
        msg ("Are you the little Dutch boy, then? Sorry, this is a big dam.")
      }
      else {
        msg ("With a " + GLOBAL.PRSI.alias + "? Do you know how big this dam is? You could only stop a tiny leak with that.")
      }
      return (true)
    }
    return (true)
  </function>

  <function name="WITH_TELL" parameters="OBJ">
    msg ("With a " + OBJ.alias + "?")
  </function>

  <function name="RESERVOIR_SOUTH_FCN" parameters="RARG" type="boolean">
    if (RARG = "M_LOOK") {
      if (GLOBAL.LOW_TIDE and GLOBAL.GATES_OPEN) {
        msg ("You are in a long room, to the north of which was formerly a lake. However, with the water level lowered, there is merely a wide stream running through the center of the room.")
      }
      else if (GLOBAL.GATES_OPEN) {
        msg ("You are in a long room. To the north is a large lake, too deep to cross. You notice, however, that the water level appears to be dropping at a rapid rate. Before long, it might be possible to cross to the other side from here.")
      }
      else if (GLOBAL.LOW_TIDE) {
        msg ("You are in a long room, to the north of which is a wide area which was formerly a reservoir, but now is merely a stream. You notice, however, that the level of the stream is rising quickly and that before long it will be impossible to cross here.")
      }
      else {
        msg ("You are in a long room on the south shore of a large lake, far too deep and wide for crossing.")
      }
      msg ("There is a path along the stream to the east or west, a steep pathway climbing southwest along the edge of a chasm, and a path leading into a canyon to the southeast.")
      return (true)
    }
    return (false)
  </function>

  <function name="RESERVOIR_FCN" parameters="RARG" type="boolean">
    if (RARG = "M_END" and not FSET_P(LOC(GLOBAL.WINNER),"VEHBIT") and not GLOBAL.GATES_OPEN and GLOBAL.LOW_TIDE) {
      msg ("You notice that the water level here is rising rapidly. The currents are also becoming stronger. Staying here seems quite perilous!")
      return (true)
    }
    else if (RARG = "M_LOOK") {
      if (GLOBAL.LOW_TIDE) {
        msg ("You are on what used to be a large lake, but which is now a large mud pile. There are \"shores\" to the north and south.")
      }
      else {
        msg ("You are on the lake. Beaches can be seen north and south. Upstream a small stream enters the lake through a narrow cleft in the rocks. The dam can be seen downstream.")
      }
      return (true)
    }
    return (false)
  </function>

  <function name="RESERVOIR_NORTH_FCN" parameters="RARG" type="boolean">
    if (RARG = "M_LOOK") {
      if (GLOBAL.LOW_TIDE and GLOBAL.GATES_OPEN) {
        msg ("You are in a large cavernous room, the south of which was formerly a lake. However, with the water level lowered, there is merely a wide stream running through there.")
      }
      else if (GLOBAL.GATES_OPEN) {
        msg ("You are in a large cavernous area. To the south is a wide lake, whose water level appears to be falling rapidly.")
      }
      else if (GLOBAL.LOW_TIDE) {
        msg ("You are in a cavernous area, to the south of which is a very wide stream. The level of the stream is rising rapidly, and it appears that before long it will be impossible to cross to the other side.")
      }
      else {
        msg ("You are in a large cavernous room, north of a large lake.")
      }
      msg ("There is a slimy stairway leaving the room to the north.")
      return (true)
    }
    return (false)
  </function>

  <function name="BOTTLE_FUNCTION" type="boolean">
    E_P = false
    if (VERB_P(V_THROW) and GLOBAL.PRSO = BOTTLE) {
      REMOVE_CAREFULLY (GLOBAL.PRSO)
      E_P = true
      msg ("The bottle hits the far wall and shatters.")
    }
    else if (VERB_P(V_MUNG)) {
      E_P = true
      REMOVE_CAREFULLY (GLOBAL.PRSO)
      msg ("A brilliant maneuver destroys the bottle.")
    }
    else if (VERB_P(V_SHAKE)) {
      if (FSET_P(GLOBAL.PRSO,"OPENBIT") and IN_P(WATER,GLOBAL.PRSO)) {
        E_P = true
      }
    }
    if (E_P and IN_P(WATER,GLOBAL.PRSO)) {
      msg ("The water spills to the floor and evaporates.")
      REMOVE_CAREFULLY (WATER)
      return (true)
    }
    else if (E_P) {
      return (true)
    }
    return (false)
  </function>

  <function name="CYCLOPS_FCN" parameters="MODE" type="boolean">
    if (not IsDefined("MODE")) {
      MODE = 0
    }
    if (TypeOf(MODE) = "int"){
      // do nothing
    }
    else {
      if (IsInt(MODE)) MODE = ToInt(MODE)
      else MODE = 0
    }
    COUNT = GLOBAL.CYCLOWRATH
    if (GLOBAL.WINNER = CYCLOPS) {
      if (GLOBAL.CYCLOPS_FLAG) {
        msg ("No use talking to him. He's fast asleep.")
      }
      else if (VERB_P(V_ODYSSEUS)) {
        GLOBAL.WINNER = ADVENTURER
        invoke (V_ODYSSEUS.script)
      }
      else {
        msg ("The cyclops prefers eating to making conversation.")
      }
      return (true)
    }
    else if (GLOBAL.CYCLOPS_FLAG) {
      if (VERB_P(V_EXAMINE)) {
        msg ("The cyclops is sleeping like a baby, albeit a very ugly one.")
        return (true)
      }
      else if (VERB_P(V_ALARM) or VERB_P(V_KICK) or VERB_P(V_ATTACK) or VERB_P(V_BURN) or VERB_P(V_MUNG)) {
        msg ("The cyclops yawns and stares at the thing that woke him up.")
        GLOBAL.CYCLOPS_FLAG = false
        FSET (CYCLOPS, "FIGHTBIT")
        if (L_P(COUNT,0)) {
          GLOBAL.CYCLOWRATH = 0 - COUNT
        }
        else {
          GLOBAL.CYCLOWRATH = COUNT
        }
        return (true)
      }
    }
    else if (VERB_P(V_EXAMINE)) {
      msg ("A hungry cyclops is standing at the foot of the stairs.")
      return (true)
    }
    else if (VERB_P(V_GIVE) and GLOBAL.PRSI = CYCLOPS) {
      if (GLOBAL.PRSO = LUNCH) {
        if (not L_P(COUNT,0)) {
          REMOVE_CAREFULLY (LUNCH)
          msg ("The cyclops says \"Mmm Mmm. I love hot peppers! But oh, could I use a drink. Perhaps I could drink the blood of that thing.\"  From the gleam in his eye, it could be surmised that you are \"that thing\".")
          GLOBAL.CYCLOWRATH = ZMIN(-1, 0 - COUNT)
        }
        ENABLE (QUEUE(I_CYCLOPS,-1))
      }
      else if (GLOBAL.PRSO = WATER or (GLOBAL.PRSO = BOTTLE and IN_P(WATER,BOTTLE))) {
        if (L_P(COUNT,0)) {
          REMOVE_CAREFULLY (WATER)
          MOVE (BOTTLE, GLOBAL.HERE)
          FSET (BOTTLE, "OPENBIT")
          FCLEAR (CYCLOPS, "FIGHTBIT")
          msg ("The cyclops takes the bottle, checks that it's open, and drinks the water. A moment later, he lets out a yawn that nearly blows you over, and then falls fast asleep (what did you put in that drink, anyway?).")
          GLOBAL.CYCLOPS_FLAG = true
        }
        else {
          msg ("The cyclops apparently is not thirsty and refuses your generous offer.")
        }
      }
      else if (GLOBAL.PRSO = GARLIC) {
        msg ("The cyclops may be hungry, but there is a limit.")
      }
      else {
        msg ("The cyclops is not so stupid as to eat THAT!")
      }
      return (true)
    }
    else if (VERB_P(V_ATTACK) or VERB_P(V_MUNG)) {
      ENABLE (QUEUE(I_CYCLOPS,-1))
      if (VERB_P(V_MUNG)) {
        msg ("\"Do you think I'm as stupid as my father was?\", he says, dodging.")
      }
      else {
        msg ("The cyclops shrugs but otherwise ignores your pitiful attempt.")
        if (VERB_P(V_THROW)) {
          MOVE (GLOBAL.PRSO, GLOBAL.HERE)
        }
      }
      return (true)
    }
    else if (VERB_P(V_TAKE)) {
      msg ("The cyclops doesn't take kindly to being grabbed.")
      return (true)
    }
    else if (VERB_P(V_TIE)) {
      msg ("You cannot tie the cyclops, though he is fit to be tied.")
      return (true)
    }
    else if (VERB_P(V_LISTEN)) {
      msg ("You can hear his stomach rumbling.")
      return (true)
    }
    return (false)
  </function>

  <turnscript name="I_CYCLOPS">
    <script>
      if (GLOBAL.CYCLOPS_FLAG or GLOBAL.DEAD) {
        // do nothing
      }
      else if (not GLOBAL.HERE = CYCLOPS_ROOM) {
        DISABLE (I_CYCLOPS)
      }
      else {
        if (G_P(abs(GLOBAL.CYCLOWRATH),5)) {
          DISABLE (I_CYCLOPS)
          JIGS_UP ("The cyclops, tired of all of your games and trickery, grabs you firmly. As he licks his chops, he says \"Mmm. Just like Mom used to make 'em.\" It's nice to be appreciated.")
        }
        else {
          if (L_P(GLOBAL.CYCLOWRATH,0)) {
            GLOBAL.CYCLOWRATH = GLOBAL.CYCLOWRATH - 1
          }
        }
        if (not GLOBAL.CYCLOPS_FLAG) {
          msg(StringListItem(GLOBAL.CYCLOMAD,abs(GLOBAL.CYCLOWRATH - 1)))
        }
      }
    </script>
  </turnscript>

  <function name="CYCLOPS_ROOM_FCN" parameters="RARG" type="boolean"><![CDATA[
    if (RARG = "M_LOOK") {
      msg ("This room has an exit on the northwest, and a staircase leading up.")
      if (GLOBAL.CYCLOPS_FLAG and not GLOBAL.MAGIC_FLAG) {
        msg ("The cyclops is sleeping blissfully at the foot of the stairs.")
      }
      else if (GLOBAL.MAGIC_FLAG) {
        msg ("The east wall, previously solid, now has a cyclops-sized opening in it.")
      }
      else if (GLOBAL.CYCLOWRATH = 0) {
        msg ("A cyclops, who looks prepared to eat horses (much less mere adventurers), blocks the staircase. From his state of health, and the bloodstains on the walls, you gather that he is not very friendly, though he likes people.")
      }
      else if (GLOBAL.CYCLOWRATH > 0) {
        msg ("The cyclops is standing in the corner, eyeing you closely. I don't think he likes you very much. He looks extremely hungry, even for a cyclops.")
      }
      else if (GLOBAL.CYCLOWRATH < 0) {
        msg ("The cyclops, having eaten the hot peppers, appears to be gasping. His enflamed tongue protrudes from his man-sized mouth.")
      }
      return (true)
    }
    else if (RARG = "M_ENTER") {
      if (GLOBAL.CYCLOWRATH = 0) {
        ENABLE (I_CYCLOPS)
      }
    }
    return (false)
  ]]></function>

  <function name="LOUD_ROOM_FCN_HELPER"><![CDATA[
    get input {
      msg (">" + result)
      if (Trim(result) = "") {
        // This never happens
        msg ("I beg your pardon?")
        LOUD_ROOM_FCN_HELPER
      }
      result = LCase(Trim(Replace(Replace(result,"\"",""),",","")))
      P_LEXV = Split(result, " ")
      WRD = StringListItem(P_LEXV,0)
      switch (WRD) {
        case ("go","walk","run") {
          WRD = P_LEXV[1]
        }
        case ("say") {
          WRD = P_LEXV[1]
        }
      }
      switch (WRD) {
        case ("save") {
          invoke (save.script)
          LOUD_ROOM_FCN_HELPER
        }
        case ("restore") {
          msg ("Quest 5 doesn't work that way. Load from the save file directly instead.")
          LOUD_ROOM_FCN_HELPER
        }
        case ("q","quit") {
          invoke (quit.script)
        }
        case ("w","west") {
          GOTO (ROUND_ROOM, true)
        }
        case ("e","east") {
          GOTO (DAMP_CAVE, true)
        }
        case ("u","up") {
          GOTO (DEEP_CANYON, true)
        }
        case ("bug") {
          msg ("That's only your opinion.")
          LOUD_ROOM_FCN_HELPER
        }
        case ("echo") {
          game.LOUD_FLAG = true
          //FSET(LOUD_ROOM,"TOUCHBIT")
          game.BAR_SACREDBIT = false
          msg ("The acoustics of the room change subtly.")
        }
        default {
          n = ListCount(P_LEXV)
          s = P_LEXV[n-1]
          msg (s + " " + s + " ...")
          LOUD_ROOM_FCN_HELPER
        }
      }
    }
  ]]></function>

  <function name="LOUD_ROOM_FCN" parameters="RARG" type="boolean">
    if (RARG = "M_LOOK") {
      TELL ("This is a large room with a ceiling which cannot be detected from the ground. There is a narrow passage from east to west and a stone stairway leading upward.")
      if (GLOBAL.LOUD_FLAG or (GLOBAL.LOW_TIDE and not GLOBAL.GATES_OPEN)) {
        TELL (" The room is eerie in its quietness.")
      }
      else {
        TELL (" The room is deafeningly loud with an undetermined rushing sound. The sound seems to reverberate from all of the walls, making it difficult even to think.")
      }
      CRLF
      return (true)
    }
    else if (RARG = "M_END" and GLOBAL.GATES_OPEN and not GLOBAL.LOW_TIDE) {
      dLog("[LOUD_ROOM_FCN] M_END and GATES_OPEN and not LOW_TIDE")
      msg ("It is unbearably loud here, with an ear-splitting roar seeming to come from all around you. There is a pounding in your head which won't stop. With a tremendous effort, you scramble out of the room.")
      GOTO (PICK_ONE_OBJECT(GLOBAL.LOUD_RUNS), true)
      return (true)
    }
    else if (RARG = "M_ENTER") {
      dLog("[LOUD_ROOM_FCN] M_ENTER...")
      if (GLOBAL.LOUD_FLAG or (GLOBAL.LOW_TIDE and not GLOBAL.GATES_OPEN)) {
        return (false)
      }
      else if (GLOBAL.GATES_OPEN and not GLOBAL.LOW_TIDE) {
        return (false)
      }
      else {
        // TODO - This is a dirty hack. Something is wrong with GOTO calling V_FIRST_LOOK in this room ;)
        //V_FIRST_LOOK
        if (GLOBAL.P_CONT > 0 or HasAttribute(game.pov,"commandqueue")) {
          msg ("The rest of your commands have been lost in the noise.")
          GLOBAL.P_CONT = 0
          RFATAL
        }
        LOUD_ROOM_FCN_HELPER
        return (true)
      }
    }
    return (false)
  </function>

  <function name="DEEP_CANYON_F" parameters="RARG" type="boolean">
    if (RARG = "M_LOOK") {
      msg ("You are on the south edge of a deep canyon. Passages lead off to the east, northwest and southwest. A stairway leads down.")
      if (GLOBAL.GATES_OPEN and not GLOBAL.LOW_TIDE) {
        TELL (" You can hear a loud roaring sound, like that of rushing water, from below.")
      }
      else if (not GLOBAL.GATES_OPEN and GLOBAL.LOW_TIDE) {
        CRLF
      }
      else {
        TELL (" You can hear the sound of flowing water from below.")
      }
      CRLF
      return (true)
    }
    return (false)
  </function>

  <function name="THIEF_VS_ADVENTURER" parameters="HERE_P" type="boolean">
    WINNER_ROBBED_P = false
    ROBBED_P = NOTHING
    if (not GLOBAL.DEAD and GLOBAL.HERE = TREASURE_ROOM) {
      // do nothing
    }
    else if (not GLOBAL.THIEF_HERE) {
      if (not GLOBAL.DEAD and not HERE_P and PROB(30)) {
        if (IN_P(STILETTO,THIEF)) {
          FCLEAR (THIEF, "INVISIBLE")
          msg ("Someone carrying a large bag is casually leaning against one of the walls here. He does not speak, but it is clear from his aspect that the bag will be taken only over his dead body.")
          GLOBAL.THIEF_HERE = true
          return (true)
        }
      }
      else if (HERE_P and FSET_P(THIEF,"FIGHTBIT") and not WINNING_P(THIEF)) {
        msg ("Your opponent, determining discretion to be the better part of valor, decides to terminate this little contretemps. With a rueful nod of his head, he steps backward into the gloom and disappears.")
        FSET (THIEF, "INVISIBLE")
        FCLEAR (THIEF, "FIGHTBIT")
        RECOVER_STILETTO
        return (true)
      }
      else if (HERE_P and FSET_P(THIEF,"FIGHTBIT") and PROB(90)) {
        return (false)
      }
      else if (HERE_P and PROB(30)) {
        msg ("The holder of the large bag just left, looking disgusted. Fortunately, he took nothing.")
        FSET (THIEF, "INVISIBLE")
        RECOVER_STILETTO
        return (TRUE)
      }
      else if (PROB(70)) {
        return (false)
      }
      else if (not GLOBAL.DEAD) {
        if (ROB(GLOBAL.HERE, THIEF, 100)) {
          ROBBED_P = GLOBAL.HERE
        }
        else if (ROB(GLOBAL.WINNER,THIEF)) {
          ROBBED_P = GLOBAL.PLAYER
        }
        GLOBAL.THIEF_HERE = true
        if (not ROBBED_P = NOTHING and not HERE_P) {
          TELL ("A seedy-looking individual with a large bag just wandered through the room. On the way through, he quietly abstracted some valuables from ")
          if (ROBBED_P = GLOBAL.HERE) {
            TELL ("the room")
          }
          else {
            TELL ("your possession")
          }
          TELL (", mumbling something about \"Doing unto others before...\"")
          STOLE_LIGHT_P
        }
        else if (HERE_P) {
          RECOVER_STILETTO
          if (not ROBBED_P = NOTHING) {
            TELL ("The thief just left, still carrying his large bag. You may not have noticed that he ")
            if (ROBBED_P = GLOBAL.PLAYER) {
              TELL ("robbed you blind first.")
            }
            else {
              TELL ("appropriated the valuables in the room.")
            }
            CRLF
            STOLE_LIGHT_P
          }
          else {
            msg ("The thief, finding nothing of value, left disgusted.")
          }
          FSET (THIEF, "INVISIBLE")
          HERE_P = false
          return (true)
        }
        else {
          msg ("A \"lean and hungry\" gentleman just wandered through, carrying a large bag. Finding nothing of value, he left disgruntled.")
          return (true)
        }
      }
    }
    else {
      if (HERE_P) {
        if (PROB(30)) {
          if (ROB(GLOBAL.HERE,THIEF,100)) {
            ROBBED_P = GLOBAL.HERE
          }
          else if (ROB (GLOBAL.WINNER, THIEF)) {
            ROBBED_P = GLOBAL.PLAYER
          }
          if (not ROBBED_P = NOTHING) {
            TELL ("The thief just left, still carrying his large bag. You may not have noticed that he ")
            if (ROBBED_P = GLOBAL.PLAYER) {
              TELL ("robbed you blind first.")
            }
            else {
              TELL ("appropriated the valuables in the room.")
            }
            CRLF
            STOLE_LIGHT_P
          }
          else {
            msg ("The thief, finding nothing of value, left disgusted.")
          }
          FSET (THIEF, "INVISIBLE")
          HERE_P = NOTHING
          RECOVER_STILETTO
        }
      }
    }
    return (false)
  </function>

  <function name="STOLE_LIGHT_P" type="boolean">
    OLD_LIT = GLOBAL.LIT
    GLOBAL.LIT = LIT_P(GLOBAL.HERE)
    if (not GLOBAL.LIT and OLD_LIT) {
      msg ("The thief seems to have left you in the dark.")
    }
    return (true)
  </function>

  <function name="HACK_TREASURES">
    RECOVER_STILETTO
    FSET (THIEF, "INVISIBLE")
    foreach (X, GetDirectChildren(TREASURE_ROOM)) {
      FCLEAR (X, "INVISIBLE")
    }
  </function>

  <function name="DEPOSIT_BOOTY" parameters="RM" type="boolean">
    FLG = false
    foreach(X,GetDirectChildren(THIEF)){
      if (X = STILETTO or X = LARGE_BAG) {
        // do nothing
      }
      else if (G_P(X.TVALUE,0)) {
        MOVE(X,RM)
        FLG = true
        if (X = EGG){
          GLOBAL.EGG_SOLVE = true
          FSET (EGG, "OPENBIT")
        }
      }
    }
    return (FLG)
  </function>

  <function name="ROB_MAZE" parameters="RM">
    pippo = false
    foreach(X,GetDirectChildren(RM)){
      if (pippo = false and FSET_P(X,"TAKEBIT") and FSET_P(X,"INVISIBLE") = false and PROB(40)) {
        msg ("You hear, off in the distance, someone saying \"My, I wonder what this fine " D .X " is doing here.\"")
        if (PROB(60,80)) {
          MOVE (X, THIEF)
          FSET (X, "TOUCHBIT")
          FSET (X, "INVISIBLE")
        }
        pippo = true // only do this with one item
      }
    }
  </function>

  <function name="ROBBER_FUNCTION" parameters="MODE" type="boolean"><![CDATA[
    dLog("[ROBBER_FUNCTION]...")
    if (not IsDefined("MODE")) {
      MODE = 0
    }
    if (TypeOf(MODE) = "int"){
      // do nothing
    }
    else {
      if (IsInt(MODE)) MODE = ToInt(MODE)
      else MODE = 0
    }
    dLog("[ROBBER_FUNCTION] MODE = " + MODE)
    if (VERB_P(V_TELL)) {
      msg ("The thief is a strong, silent type.")
      GLOBAL.P_CONT = 0
      return (true)
    }
    if (MODE = 0) {
      dLog("[ROBBER_FUNCTION] MODE is 0...")
      if (VERB_P(V_HELLO) and THIEF.LDESC = GLOBAL.ROBBER_U_DESC) {
        msg ("The thief, being temporarily incapacitated, is unable to acknowledge your greeting with his usual graciousness.")
      }
      else if (GLOBAL.PRSO = KNIFE and VERB_P(V_THROW) and not FSET_P(THIEF,"FIGHTBIT")) {
        MOVE (GLOBAL.PRSO, GLOBAL.HERE)
        if (PROB(10,0)) {
          TELL ("You evidently frightened the robber, though you didn't hit him. He flees")
          REMOVE (LARGE_BAG)
          X = false
          if (IN_P(STILETTO,THIEF)) {
            REMOVE (STILETTO)
            X = true
          }
          if (not FIRST_P(THIEF) = NOTHING) {
            MOVE_ALL (THIEF, GLOBAL.HERE)
            TELL (", but the contents of his bag fall on the floor.")
          }
          else {
            TELL (".")
          }
          MOVE (LARGE_BAG, THIEF)
          if (X) {
            MOVE (STILETTO, THIEF)
          }
          CRLF
          FSET (THIEF, "INVISIBLE")
        }
        else {
          msg ("You missed. The thief makes no attempt to take the knife, though it would be a fine addition to the collection in his bag. He does seem angered by your attempt.")
          FSET (THIEF, "FIGHTBIT")
        }
        return (true)
      }
      else if ((VERB_P(V_THROW) or VERB_P(V_GIVE)) and not GLOBAL.PRSO = NOTHING and not GLOBAL.PRSO = THIEF and GLOBAL.PRSI = THIEF) {
        if (L_P(THIEF.STRENGTH,0)) {
          THIEF.STRENGTH = 0 - THIEF.STRENGTH
          ENABLE (I_THIEF)
          RECOVER_STILETTO
          THIEF.LDESC = GLOBAL.ROBBER_C_DESC
          msg ("Your proposed victim suddenly recovers consciousness.")
        }
        MOVE (GLOBAL.PRSO, THIEF)
        if (G_P(GLOBAL.PRSO.TVALUE,0)) {
          GLOBAL.THIEF_ENGROSSED = true
          msg ("The thief is taken aback by your unexpected generosity, but accepts the " + GLOBAL.PRSO.alias + " and stops to admire its beauty.")
        }
        else {
          msg ("The thief places the " + GLOBAL.PRSO.alias + " in his bag and thanks you politely.")
        }
        return (true)
      }
      else if (VERB_P(V_TAKE)) {
        msg ("Once you got him, what would you do with him?")
        return (true)
      }
      else if (VERB_P(V_EXAMINE) or VERB_P(V_LOOK_INSIDE)) {
        msg ("The thief is a slippery character with beady eyes that flit back and forth. He carries, along with an unmistakable arrogance, a large bag over his shoulder and a vicious stiletto, whose blade is aimed menacingly in your direction. I'd watch out if I were you.")
        return (true)
      }
      else if (VERB_P(V_LISTEN)) {
        msg ("The thief says nothing, as you have not been formally introduced.")
        return (true)
      }
    }
    else if (MODE = GLOBAL.F_BUSY_P) { //1 F_BUSY_P
      dLog("[ROBBER_FUNCTION] MODE = 1 (F_BUSY_P)")
      if (IN_P(STILETTO,THIEF)) {
        dLog("[ROBBER_FUNCTION] thief has stiletto; returning false")
        return (false)
      }
      else if (IN_P(STILETTO,LOC(THIEF))) {
        dLog("[ROBBER_FUNCTION] stiletto in thief's location...")
        MOVE (STILETTO, THIEF)
        FSET (STILETTO, "NDESCBIT")
        if (IN_P(THIEF,GLOBAL.HERE)) {
          dLog("[ROBBER_FUNCTION] thief is in the room; so report stiletto retrieval")
          msg ("The robber, somewhat surprised at this turn of events, nimbly retrieves his stiletto.")
        }
        dLog("[ROBBER_FUNCTION] thief has recovered stiletto; returning true")
        return (true)
      }
    }
    else if (MODE = GLOBAL.F_DEAD) { //2 F_DEAD
      dLog("[ROBBER_FUNCTION] MODE = 2 (F_DEAD)")
      MOVE (STILETTO, GLOBAL.HERE)
      FCLEAR (STILETTO, "NDESCBIT")
      X = DEPOSIT_BOOTY(GLOBAL.HERE)
      FLG = false
      if (GLOBAL.HERE = TREASURE_ROOM) {
        foreach(X,GetDirectChildren(GLOBAL.HERE)){
          if (not X = CHALICE and not X = THIEF and not X = ADVENTURER){
            FCLEAR (X, "INVISIBLE")
            if (not FLG) {
              FLG = true
              msg ("As the thief dies, the power of his magic decreases, and his treasures reappear:")
            }
            TELL ("&nbsp;&nbsp;A " + X.alias)
            if (not FIRST_P(X) = NOTHING and SEE_INSIDE_P(X)) {
              TELL (", with ")
              PRINT_CONTENTS (X)
            }
            CRLF
          }
        }
        msg ("The chalice is now safe to take.")
      }
      else if (X) {
        msg ("His booty remains.")
      }
      DISABLE (I_THIEF)
      return (true)
    }
    else if (MODE = GLOBAL.F_FIRST_P) { //5 F_FIRST_P
      dLog("[ROBBER_FUNCTION] MODE = 5 (F_FIRST_P)")
      if (GLOBAL.THIEF_HERE and not FSET_P(THIEF,"INVISIBLE") and PROB(20)) {
        FSET (THIEF, "FIGHTBIT")
        GLOBAL.P_CONT = 0
        return (true)
      }
    }
    else if (MODE = GLOBAL.F_UNCONSCIOUS) { //3 F_UNCONSCIOUS
      dLog("[ROBBER_FUNCTION] MODE = UNCONSCIOUS")
      DISABLE (I_THIEF)
      FCLEAR (THIEF, "FIGHTBIT")
      MOVE (STILETTO, GLOBAL.HERE)
      FCLEAR (STILETTO, "NDESCBIT")
      THIEF.LDESC = GLOBAL.ROBBER_U_DESC
      return (true)
    }
    else if (MODE = GLOBAL.F_CONSCIOUS) { //4 F_CONSCIOUS
      dLog("[ROBBER_FUNCTION] MODE = CONSCIOUS")
      if (LOC(THIEF) = GLOBAL.HERE) {
        FSET (THIEF, "FIGHTBIT")
        msg ("The robber revives, briefly feigning continued unconsciousness, and, when he sees his moment, scrambles away from you.")
      }
      ENABLE (I_THIEF)
      THIEF.LDESC = GLOBAL.ROBBER_C_DESC
      RECOVER_STILETTO
      return (true)
    }
    dLog("[ROBBER_FUNCTION] END; returning false")
    return (false)
  ]]></function>

  <function name="LARGE_BAG_F" type="boolean">
    if (VERB_P(V_TAKE)) {
      if (THIEF.LDESC = GLOBAL.ROBBER_U_DESC) {
        msg ("Sadly for you, the robber collapsed on top of the bag. Trying to take it would wake him.")
      }
      else {
        msg ("The bag will be taken over his dead body.")
      }
      return (true)
    }
    else if (VERB_P(V_PUT) and GLOBAL.PRSI = LARGE_BAG) {
      msg ("It would be a good trick.")
      return (true)
    }
    else if (VERB_P(V_OPEN) or VERB_P(V_CLOSE)) {
      msg ("Getting close enough would be a good trick.")
      return (true)
    }
    else if (VERB_P(V_EXAMINE) or VERB_P(V_LOOK_INSIDE)) {
      msg ("The bag is underneath the thief, so one can't say what, if anything, is inside.")
      return (true)
    }
    return (false)
  </function>

  <function name="MOVE_ALL" parameters="FROM, TO">
    foreach(X,FROM){
      FCLEAR(X,"INVISIBLE")
      MOVE(X,TO)
    }
  </function>

  <function name="CHALICE_FCN" type="boolean">
    if (VERB_P(V_TAKE)){
      if (IN_P(GLOBAL.PRSO,TREASURE_ROOM) and IN_P(THIEF,TREASURE_ROOM) and FSET_P(THIEF,"FIGHTBIT") and not FSET_P(THIEF,"INVISIBLE") and not THIEF.LDESC = GLOBAL.ROBBER_U_DESC) {
        msg ("You'd be stabbed in the back first.")
        return (true)
      }
    }
    else if (VERB_P(V_PUT) and GLOBAL.PRSI = CHALICE) {
      msg ("You can't. It's not a very good chalice, is it?")
      return (true)
    }
    else {
      return (DUMB_CONTAINER())
    }
    return (false)
  </function>

  <function name="TREASURE_ROOM_FCN" parameters="RARG" type="boolean">
    if (RARG = "M_ENTER" and I_THIEF.enabled and not GLOBAL.DEAD) {
      if (not IN_P(THIEF, GLOBAL.HERE)) {
        msg ("You hear a scream of anguish as you violate the robber's hideaway. Using passages unknown to you, he rushes to its defense.")
        MOVE (THIEF, GLOBAL.HERE)
      }
      FSET (THIEF, "FIGHTBIT")
      FCLEAR (THIEF, "INVISIBLE")
      THIEF_IN_TREASURE
      return (true)
    }
    return (false)
  </function>

  <function name="THIEF_IN_TREASURE">
    frobbed = false
    foreach(F, GetDirectChildren(GLOBAL.HERE)){
      if (not F = CHALICE and not F = THIEF){
        FSET (F, "INVISIBLE")
        frobbed = true
      }
    }
    if (frobbed){
      msg("The thief gestures mysteriously, and the treasures in the room suddenly vanish.")
      CRLF
    }
  </function>

  <function name="FRONT_DOOR_FCN" type="boolean">
    if (VERB_P(V_OPEN)) {
      msg ("The door cannot be opened.")
      return (true)
    }
    else if (VERB_P(V_BURN)) {
      msg ("You cannot burn this door.")
      return (true)
    }
    else if (VERB_P(V_MUNG)) {
      msg ("You can't seem to damage the door.")
      return (true)
    }
    else if (VERB_P(V_LOOK_BEHIND)) {
      msg ("It won't open.")
      return (true)
    }
    return (false)
  </function>

  <function name="BODY_FUNCTION" type="boolean">
    if (VERB_P("TAKE")) {
      msg ("A force keeps you from taking the bodies.")
      return (true)
    }
    if (VERB_P("MUNG BURN")) {
      JIGS_UP ("The voice of the guardian of the dungeon booms out from the darkness, \"Your disrespect costs you your life!\" and places your head on a sharp pole.")
      return (true)
    }
    return (false)
  </function>

  <function name="BLACK_BOOK" type="boolean">
    dLog("[BLACK_BOOK]...")
    if (VERB_P("OPEN")) {
      msg ("The book is already open to page 569.")
      return (true)
    }
    else if (VERB_P("CLOSED")) {
      msg ("As hard as you try, the book cannot be closed.")
      return (true)
    }
    //else if (VERB_P(V_TURN) or (VERB_P(V_READ_PAGE) and GLOBAL.PRSI = GLOBAL.INTNUM and not GLOBAL.P_NUMBER = 569)) {
    else if (VERB_P(V_TURN) or (VERB_P(V_READ_PAGE) and not EndsWith(game.pov.currentcommand,"569"))) {
      msg ("Beside page 569, there is only one other page with any legible printing on it. Most of it is unreadable, but the subject seems to be the banishment of evil. Apparently, certain noises, lights, and prayers are efficacious in this regard.")
      return (true)
    }
    else if (VERB_P(V_BURN)) {
      REMOVE_CAREFULLY (GLOBAL.PRSO)
      JIGS_UP ("A booming voice says \"Wrong, cretin!\" and you notice that you have turned into a pile of dust. How, I can't imagine.")
      return (true)
    }
    dLog("[BLACK_BOOK] ends")
    return (false)
  </function>

  <function name="PAINTING_FCN" type="boolean">
    if (VERB_P(V_MUNG)) {
      GLOBAL.PRSO.TVALUE = 0
      GLOBAL.PRSO.LDESC = "There is a worthless piece of canvas here."
      msg ("Congratulations! Unlike the other vandals, who merely stole the artist's masterpieces, you have destroyed one.")
      return (true)
    }
    return (false)
  </function>

  <function name="LANTERN" type="boolean">
    if (VERB_P(V_THROW)) {
      msg ("The lamp has smashed into the floor, and the light has gone out.")
      DISABLE (I_LANTERN)
      REMOVE_CAREFULLY (LAMP)
      MOVE (BROKEN_LAMP, GLOBAL.HERE)
      return (true)
    }
    else if (VERB_P(V_LAMP_ON)) {
      if (FSET_P(LAMP,"RMUNGBIT")) {
        msg ("A burned-out lamp won't light.")
        return (true)
      }
      else {
        ENABLE (I_LANTERN)
      }
    }
    else if (VERB_P(V_LAMP_OFF)) {
      if (FSET_P(LAMP,"RMUNGBIT")) {
        msg ("The lamp has already burned out.")
        return (true)
      }
      else {
        DISABLE (I_LANTERN)
      }
    }
    else if (VERB_P(V_EXAMINE)) {
      TELL ("The lamp ")
      if (FSET_P(LAMP,"RMUNGBIT")) {
        msg ("has burned out.")
      }
      else if (FSET_P(LAMP,"ONBIT")) {
        msg ("is on.")
      }
      else {
        msg ("is turned off.")
      }
      return (true)
    }
    return (false)
  </function>

  <function name="MAILBOX_F" type="boolean">
    if (VERB_P(V_TAKE) and GLOBAL.PRSO = MAILBOX) {
      msg ("It is securely anchored.")
      return (true)
    }
    return (false)
  </function>

  <function name="MATCH_FUNCTION" type="boolean"><![CDATA[
    if (VERB_P("LAMP_ON BURN") and GLOBAL.PRSO = MATCH) {
      if (G_P(GLOBAL.MATCH_COUNT,0)) {
        GLOBAL.MATCH_COUNT = GLOBAL.MATCH_COUNT - 1
      }
      if (not G_P(GLOBAL.MATCH_COUNT,0)) {
        msg ("I'm afraid that you have run out of matches.")
      }
      else if (GLOBAL.HERE = LOWER_SHAFT or GLOBAL.HERE = TIMBER_ROOM) {
        msg ("This room is drafty, and the match goes out instantly.")
      }
      else {
        FSET (MATCH, "FLAMEBIT")
        FSET (MATCH, "ONBIT")
        ENABLE (QUEUE(I_MATCH,2))
        msg ("One of the matches starts to burn.")
        if (not GLOBAL.LIT) {
          GLOBAL.LIT = true
          invoke (V_LOOK.script)
        }
      }
      return (true)
    }
    else if (VERB_P(V_LAMP_OFF) and FSET_P(MATCH,"FLAMEBIT")) {
      msg ("The match is out.")
      FCLEAR (MATCH, "FLAMEBIT")
      FCLEAR (MATCH, "ONBIT")
      GLOBAL.LIT = LIT_P(GLOBAL.HERE)
      if (not GLOBAL.LIT) {
        msg ("It's pitch black in here!")
      }
      QUEUE (I_MATCH, 0)
      return (true)
    }
    else if (VERB_P("COUNT OPEN")) {
      TELL ("You have ")
      //msg(TypeOf(GLOBAL.MATCH_COUNT))
      CNT = GLOBAL.MATCH_COUNT - 1
      if (not G_P(CNT,0)) {
        TELL ("no")
      }
      else {
        TELL (ToString(CNT))
      }
      TELL (" match")
      if (not CNT = 1) {
        TELL ("es.")
      }
      else {
        TELL (".")
      }
      CRLF
      return (true)
    }
    else if (VERB_P(V_EXAMINE)) {
      if (FSET_P(MATCH,"ONBIT")) {
        msg ("The match is burning.")
      }
      else {
        msg ("The matchbook isn't very interesting, except for what's written on it.")
      }
      return (true)
    }
    return (false)
  ]]></function>

  <turnscript name="I_MATCH">
    <script>
      msg ("The match has gone out.")
      FCLEAR (MATCH, "FLAMEBIT")
      FCLEAR (MATCH, "ONBIT")
      GLOBAL.LIT = LIT_P(GLOBAL.HERE)
      DISABLE(I_MATCH)
    </script>
  </turnscript>

  <turnscript name="I_LANTERN">
    <script>
      TBL = GLOBAL.LAMP_TABLE
      TICK = ToInt(StringListItem(TBL,0))
      ENABLE (QUEUE(I_LANTERN,TICK))
      LIGHT_INT (LAMP, TBL, TICK)
      if (not TICK = 0) {
        GLOBAL.LAMP_TABLE = REST(TBL,2)
      }
    </script>
  </turnscript>

  <turnscript name="I_CANDLES">
    <script>
      TBL = GLOBAL.CANDLE_TABLE
      FSET (CANDLES, "TOUCHBIT")
      TICK = ToInt(StringListItem(TBL,0))
      ENABLE (QUEUE (I_CANDLES, TICK))
      LIGHT_INT (CANDLES, TBL, TICK)
      if (not TICK = 0) {
        GLOBAL.CANDLE_TABLE = REST(TBL,2)
      }
    </script>
  </turnscript>

  <function name="LIGHT_INT" parameters="OBJ, TBL, TICK">
    if (TICK = 0) {
      FCLEAR (OBJ, "ONBIT")
      OBJ.switchedon = false
      FSET (OBJ, "RMUNGBIT")
      pippo = CheckDarkness()
      GLOBAL.LIT = LIT_P(GLOBAL.HERE)
    }
    if (HELD_P(OBJ) or IN_P(OBJ, GLOBAL.HERE)) {
      if (TICK = 0) {
        msg ("You'd better have more light than from the " + OBJ.alias + ".")
      }
      else {
        msg (StringListItem(TBL,1))
      }
    }
  </function>

  <function name="CANDLES_FCN" type="boolean">
    if (not FSET_P(CANDLES,"TOUCHBIT")) {
      ENABLE (I_CANDLES)
    }
    if (CANDLES = GLOBAL.PRSI) {
      return (false)
    }
    else {
      if (VERB_P("LAMP_ON BURN")) {
        if (FSET_P(CANDLES,"RMUNGBIT")) {
          msg ("Alas, there's not much left of the candles. Certainly not enough to burn.")
        }
        else if (GLOBAL.PRSI = NOTHING) {
          if (FSET_P(MATCH,"FLAMEBIT")) {
            msg ("(with the match)")
            PERFORM (V_LAMP_ON, CANDLES, MATCH)
          }
          else {
            msg ("You should say what to light them with.")
            RFATAL
          }
        }
        else if (GLOBAL.PRSI = MATCH and FSET_P(MATCH,"ONBIT")) {
          TELL ("The candles are ")
          if (FSET_P(CANDLES,"ONBIT")) {
            msg ("already lit.")
          }
          else {
            FSET (CANDLES, "ONBIT")
            msg ("lit.")
            ENABLE (I_CANDLES)
          }
        }
        else if (GLOBAL.PRSI = TORCH) {
          if (FSET_P(CANDLES,"ONBIT")) {
            msg ("You realize, just in time, that the candles are already lighted.")
          }
          else {
            msg ("The heat from the torch is so intense that the candles are vaporized.")
            REMOVE_CAREFULLY (CANDLES)
          }
        }
        else {
          msg ("You have to light them with something that's burning, you know.")
        }
        return (true)
      }
      else if (VERB_P(V_COUNT)) {
        msg ("Let's see, how many objects in a pair? Don't tell me, I'll get it.")
        return (true)
      }
      else if (VERB_P(V_LAMP_OFF)) {
        DISABLE (I_CANDLES)
        if (FSET_P(CANDLES,"ONBIT")) {
          TELL ("The flame is extinguished.")
          FCLEAR (CANDLES, "ONBIT")
          FSET (CANDLES, "TOUCHBIT")
          GLOBAL.LIT = LIT_P(GLOBAL.HERE)
          if (not GLOBAL.LIT) {
            TELL (" It's really dark in here....")
          }
          CRLF
          return (true)
        }
        else {
          msg ("The candles are not lighted.")
          return (true)
        }
      }
      else if (VERB_P(V_PUT) and FSET_P(GLOBAL.PRSI,"BURNBIT")) {
        msg ("That wouldn't be smart.")
        return (true)
      }
      else if (VERB_P(V_EXAMINE)) {
        TELL ("The candles are ")
        if (FSET_P(CANDLES,"ONBIT")) {
          TELL ("burning.")
        }
        else {
          TELL ("out.")
        }
        CRLF
        return (true)
      }
    }
    return (false)
  </function>

  <function name="CAVE2_ROOM" parameters="RARG" type="boolean">
    if (RARG = "M_END") {
      if (IN_P(CANDLES,GLOBAL.WINNER) and PROB(50,80) and FSET_P(CANDLES,"ONBIT")) {
        msg ("A gust of wind blows out your candles!")
        GLOBAL.LIT = LIT_P(GLOBAL.HERE)
        if (not GLOBAL.LIT) {
          msg ("It is now completely dark.")
        }
        return (true)
      }
    }
    return (false)
  </function>

  <function name="SWORD_FCN" type="boolean">
    if (VERB_P(V_TAKE) and GLOBAL.WINNER = ADVENTURER) {
      ENABLE (QUEUE (I_SWORD, -1))
      return (false)
    }
    else if (VERB_P(V_EXAMINE)) {
      G = SWORD.TVALUE
      if (G = 1) {
        msg ("Your sword is glowing with a faint blue glow.")
        return (true)
      }
      else if (G = 2) {
        msg ("Your sword is glowing very brightly.")
        return (true)
      }
    }
    return (false)
  </function>

  <function name="BOOM_ROOM" parameters="RARG" type="boolean"><![CDATA[
    DUMMY_P = false
    if (RARG = "M_END") {
      if (VERB_P("LAMP_ON BURN") and (GLOBAL.PRSO = CANDLES or GLOBAL.PRSO = TORCH or GLOBAL.PRSO = MATCH)) {
        DUMMY_P = true
      }
      if ((HELD_P(CANDLES) and FSET_P(CANDLES,"ONBIT")) or (HELD_P(TORCH) and FSET_P(TORCH,"ONBIT")) or (HELD_P(MATCH) and FSET_P(MATCH,"ONBIT"))) {
        if (DUMMY_P) {
          msg ("How sad for an aspiring adventurer to light a " + GLOBAL.PRSO.alias + " in a room which reeks of gas. Fortunately, there is justice in the world.")
        }
        else {
          msg ("Oh dear. It appears that the smell coming from this room was coal gas. I would have thought twice about carrying flaming objects in here.")
        }
        JIGS_UP ("<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;** BOOOOOOOOOOOM **")
      }
    }
    return (false)
  ]]></function>

  <function name="BAT_D" parameters="RARG" type="boolean">
    // if (GLOBAL.HERE = LOC(GARLIC) or LOC(GARLIC) = GLOBAL.WINNER) {
      if (LOC(GARLIC) = GLOBAL.WINNER or LOC(GARLIC) = GLOBAL.HERE) {
        msg ("In the corner of the room on the ceiling is a large vampire bat who is obviously deranged and holding his nose.")
      }
      else {
        msg ("A large vampire bat, hanging from the ceiling, swoops down at you!")
      }
      return (true)
  </function>

  <function name="BATS_ROOM" parameters="RARG" type="boolean">
    if (RARG = "M_LOOK") {
      msg ("You are in a small room which has doors only to the east and south.")
      return (true)
    }
    else if (RARG = "M_ENTER" and not GLOBAL.DEAD) {
      if (not LOC(GARLIC) = GLOBAL.WINNER and not LOC(GARLIC) = GLOBAL.HERE) {
        invoke (V_LOOK.script)
        CRLF
        FLY_ME
        // TODO - I think it should return true here?
        return (true)
      }
    }
    return (false)
  </function>

  <function name="MACHINE_ROOM_FCN" parameters="RARG" type="boolean">
    if (RARG = "M_LOOK") {
      TELL ("This is a large, cold room whose sole exit is to the north. In one corner there is a machine which is reminiscent of a clothes dryer. On its face is a switch which is labelled \"START\". The switch does not appear to be manipulable by any human hand (unless the fingers are about 1/16 by 1/4 inch). On the front of the machine is a large lid, which is ")
      if (FSET_P(MACHINE,"OPENBIT")) {
        msg ("open.")
      }
      else {
        msg ("closed")
      }
      return (true)
    }
    return (false)
  </function>

  <function name="MACHINE_F" type="boolean">
    if (VERB_P(V_TAKE) and GLOBAL.PRSO = MACHINE) {
      msg ("It is far too large to carry.")
      return (true)
    }
    else if (VERB_P(V_OPEN)) {
      if (FSET_P(MACHINE,"OPENBIT")) {
        msg (PICK_ONE(GLOBAL.DUMMY))
      }
      else if (not FIRST_P(MACHINE) = NOTHING) {
        TELL ("The lid opens, revealing ")
        PRINT_CONTENTS (MACHINE)
        msg (".")
        FSET (MACHINE, "OPENBIT")
      }
      else {
        msg ("The lid opens.")
        FSET (MACHINE, "OPENBIT")
      }
      return (true)
    }
    else if (VERB_P(V_CLOSE)) {
      if (FSET_P(MACHINE,"OPENBIT")) {
        msg ("The lid closes.")
        FCLEAR (MACHINE, "OPENBIT")
      }
      else {
        msg (PICK_ONE(GLOBAL.DUMMY))
      }
      return (true)
    }
    else if (VERB_P(V_LAMP_ON)) {
      if (GLOBAL.PRSI = NOTHING) {
        msg ("It's not clear how to turn it on with your bare hands.")
      }
      else {
        PERFORM (V_TURN, MACHINE_SWITCH, GLOBAL.PRSI)
      }
      return (true)
    }
    return (false)
  </function>

  <function name="MSWITCH_FUNCTION" type="boolean">
    if (VERB_P(V_TURN)) {
      if (GLOBAL.PRSI = SCREWDRIVER) {
        if (FSET_P(MACHINE,"OPENBIT")) {
          msg ("The machine doesn't seem to want to do anything.")
        }
        else {
          msg ("The machine comes to life (figuratively) with a dazzling display of colored lights and bizarre noises. After a few moments, the excitement abates.")
          if (IN_P(COAL,MACHINE)) {
            REMOVE_CAREFULLY (COAL)
            MOVE (DIAMOND, MACHINE)
          }
          else {
            foreach(O, GetDirectChildren(MACHINE)){
              REMOVE_CAREFULLY (O)
            }
            MOVE (GUNK, MACHINE)
          }
        }
      }
      else {
        msg ("It seems that a " + GLOBAL.PRSI.alias + " won't do.")
      }
      return (true)
    }
    return (false)
  </function>

  <function name="GUNK_FUNCTION">
    REMOVE_CAREFULLY (GUNK)
    msg ("The slag was rather insubstantial, and crumbles into dust at your touch.")
  </function>

  <function name="NO_OBJS" parameters="RARG" type="boolean">
    if (RARG = "M_BEG") {
      GLOBAL.EMPTY_HANDED = true
      foreach(F, GetDirectChildren(GLOBAL.WINNER)){
        if (G_P(WEIGHT(F),4)) {
          GLOBAL.EMPTY_HANDED = false
        }
      }
      if (GLOBAL.HERE = LOWER_SHAFT and GLOBAL.LIT) {
        SCORE_UPD (GLOBAL.LIGHT_SHAFT)
        GLOBAL.LIGHT_SHAFT = 0
      }
      return (false)
    }
    return (false)
  </function>

  <function name="SOUTH_TEMPLE_FCN" parameters="RARG" type="boolean">
    dLog("[SOUTH_TEMPLE_FCN]...")
    if (RARG = "M_BEG") {
      dLog("[SOUTH_TEMPLE_FCN] M_BEG ...")
      GLOBAL.COFFIN_CURE = not IN_P(COFFIN,GLOBAL.WINNER)
      dLog("[SOUTH_TEMPLE_FCN] M_BEG IN_P(COFFIN,GLOBAL.WINNER)=" + IN_P(COFFIN,GLOBAL.WINNER))
      dLog("[SOUTH_TEMPLE_FCN] M_BEG GLOBAL.COFFIN_CURE=" + GLOBAL.COFFIN_CURE)
      return (false)
    }
    return (false)
  </function>

  <function name="WHITE_CLIFFS_FUNCTION" parameters="RARG" type="boolean">
    if (RARG = "M_END") {
      if (IN_P(INFLATED_BOAT,GLOBAL.WINNER)) {
        GLOBAL.DEFLATE = false
      }
      else {
        GLOBAL.DEFLATE = true
      }
    }
    return (false)
  </function>

  <function name="SCEPTRE_FUNCTION" type="boolean">
    if (VERB_P("WAVE RAISE")) {
      if (GLOBAL.HERE = ARAGAIN_FALLS or GLOBAL.HERE = END_OF_RAINBOW) {
        if (not GLOBAL.RAINBOW_FLAG) {
          FCLEAR (POT_OF_GOLD, "INVISIBLE")
          msg ("Suddenly, the rainbow appears to become solid and, I venture, walkable (I think the giveaway was the stairs and bannister).")
          if (GLOBAL.HERE = END_OF_RAINBOW and IN_P(POT_OF_GOLD,END_OF_RAINBOW)) {
            msg ("A shimmering pot of gold appears at the end of the rainbow.")
          }
          GLOBAL.RAINBOW_FLAG = true
        }
        else {
          ROB (ON_RAINBOW, WALL)
          msg ("The rainbow seems to have become somewhat run-of-the-mill.")
          GLOBAL.RAINBOW_FLAG = false
          return (true)
        }
      }
      else if (GLOBAL.HERE = ON_RAINBOW) {
        GLOBAL.RAINBOW_FLAG = false
        JIGS_UP ("The structural integrity of the rainbow is severely compromised, leaving you hanging in midair, supported only by water vapor. Bye.")
      }
      else {
        msg ("A dazzling display of color briefly emanates from the sceptre.")
      }
      return (true)
    }
    return (false)
  </function>

  <function name="FALLS_ROOM" parameters="RARG" type="boolean">
    if (RARG = "M_LOOK") {
      msg ("You are at the top of Aragain Falls, an enormous waterfall with a drop of about 450 feet. The only path here is on the north end.")
      if (GLOBAL.RAINBOW_FLAG) {
        msg ("A solid rainbow spans the falls.")
      }
      else {
        msg ("A beautiful rainbow can be seen over the falls and to the west.")
      }
      return (true)
    }
    return (false)
  </function>

  <function name="RAINBOW_FCN" type="boolean">
    if (VERB_P("CROSS THROUGH")) {
      if (GLOBAL.HERE = CANYON_VIEW) {
        msg ("From here?!?")
        return (true)
      }
      if (GLOBAL.RAINBOW_FLAG) {
        if (GLOBAL.HERE = ARAGAIN_FALLS) {
          GOTO (END_OF_RAINBOW, true)
        }
        else if (GLOBAL.HERE = END_OF_RAINBOW) {
          GOTO (ARAGAIN_FALLS, true)
        }
        else {
          msg ("You'll have to say which way...")
        }
      }
      else {
        msg ("Can you walk on water vapor?")
      }
      return (true)
    }
    else if (VERB_P(V_LOOK_UNDER)) {
      msg ("The Frigid River flows under the rainbow.")
      return (true)
    }
    return (false)
  </function>

  <function name="DBOAT_FUNCTION" type="boolean">
    if (VERB_P("PUT PUT_ON") and GLOBAL.PRSO = PUTTY) {
      FIX_BOAT
      return (true)
    }
    else if (VERB_P("INFLATE FILL")) {
      msg ("No chance. Some moron punctured it.")
      return (true)
    }
    else if (VERB_P(V_PLUG)) {
      if (GLOBAL.PRSI = PUTTY) {
        FIX_BOAT
      }
      else {
        WITH_TELL (GLOBAL.PRSI)
      }
      return (true)
    }
    return (false)
  </function>

  <function name="FIX_BOAT">
    msg ("Well done. The boat is repaired.")
    MOVE (INVFLATABLE_BOAT, LOC (PUNCTURED_BOAT))
    REMOVE_CAREFULLY (PUNCTURED_BOAT)
  </function>

  <function name="RIVER_FUNCTION" type="boolean">
    if (VERB_P(V_PUT)) {
      if (GLOBAL.PRSI = RIVER) {
        if (GLOBAL.PRSO = ME) {
          JIGS_UP ("You splash around for a while, fighting the current, then you drown.")
        }
        else if (GLOBAL.PRSO = INFLATED_BOAT) {
          msg ("You should get in the boat then launch it.")
        }
        else if (FSET_P(GLOBAL.PRSO, "BURNBIT")) {
          REMOVE_CAREFULLY (GLOBAL.PRSO)
          msg ("The " + GLOBAL.PRSO.alias + " floats for a moment, then sinks.")
        }
        else {
          REMOVE_CAREFULLY (GLOBAL.PRSO)
          msg ("The " + GLOBAL.PRSO.alias + " splashes into the water and is gone forever.")
        }
        return (true)
      }
    }
    else if (VERB_P("LEAP THROUGH")) {
      msg ("A look before leaping reveals that the river is wide and dangerous, with swift currents and large, half-hidden rocks. You decide to forgo your swim.")
      return (true)
    }
    return (false)
  </function>

  <turnscript name="I_RIVER">
    <script>
      dLog("[I_RIVER]...")
      if (not GLOBAL.HERE = RIVER_1 and not GLOBAL.HERE = RIVER_2 and not GLOBAL.HERE = RIVER_3 and not GLOBAL.HERE = RIVER_4 and not GLOBAL.HERE = RIVER_5) {
        DISABLE (I_RIVER)
      }
      else {
        RM = DictionaryItem(LKP(GLOBAL.HERE, GLOBAL.RIVER_NEXT),"result")
        dLog("I_RIVER: RM = " + RM)
        if (not RM = NOTHING) {
          msg ("The flow of the river carries you downstream.")
          GOTO (RM, true)
          i = DictionaryItem(LKP(GLOBAL.HERE, GLOBAL.RIVER_SPEEDS),"result")
          ENABLE (QUEUE (I_RIVER, i + 2))
        }
        else {
          pippo = JIGS_UP ("Unfortunately, the magic boat doesn't provide protection from the rocks and boulders one meets at the bottom of waterfalls. Including this one.")
        }
      }
    </script>
  </turnscript>

  <function name="RBOAT_FUNCTION" parameters="RARG" type="boolean">
    if (not IsDefined("RARG")) {
      RARG = "undefined"
    }
    if (RARG = "M_ENTER" or RARG = "M_END" or RARG = "M_LOOK") {
      return (false)
    }
    else if (RARG = "M_BEG") {
      dLog("[RBOAT_FUNCTION] RARG = M_BEG")
      if (VERB_P(V_WALK)) {
        if (GLOBAL.P_WALK_DIR = "land" or GLOBAL.P_WALK_DIR = "east" or GLOBAL.P_WALK_DIR = "west") {
          return (false)
        }
        else if (GLOBAL.HERE = RESERVOIR and (GLOBAL.P_WALK_DIR = "north" or GLOBAL.P_WALK_DIR = "south")) {
          return (false)
        }
        else if (GLOBAL.HERE = IN_STREAM and GLOBAL.P_WALK_DIR = "south") {
          return (false)
        }
        else {
          msg ("Read the label for the boat's instructions.")
          return (true)
        }
      }
      else if (VERB_P(V_LAUNCH)) {
        dLog("[RBOAT_FUNCTION] VERB is LAUNCH")
        if (GLOBAL.HERE = RIVER_1 or GLOBAL.HERE = RIVER_2 or GLOBAL.HERE = RIVER_3 or GLOBAL.HERE = RIVER_4 or GLOBAL.HERE = RESERVOIR or GLOBAL.HERE = IN_STREAM) {
          TELL ("You are on the ")
          if (GLOBAL.HERE = RESERVOIR) {
            TELL ("reservoir")
          }
          else if (GLOBAL.HERE = IN_STREAM) {
            TELL ("stream")
          }
          else {
            TELL ("river")
          }
          msg (", or have you forgotten?")
          return (true)
        }
        else if (GO_NEXT(GLOBAL.RIVER_LAUNCH) = 1) {
          TMP = 1
          qtick = DictionaryItem(LKP(GLOBAL.HERE,GLOBAL.RIVER_SPEEDS),"result")
          ENABLE (QUEUE (I_RIVER, qtick))
          return (true)
        }
        else if (not GO_NEXT(GLOBAL.RIVER_LAUNCH) = 2) {
          msg ("You can't launch it here.")
          return (true)
        }
        else {
          return (true)
        }
      }
      else if ((VERB_P(V_DROP) and FSET_P(GLOBAL.PRSO,"WEAPONBIT")) or (VERB_P(V_PUT) and FSET_P(GLOBAL.PRSO,"WEAPONBIT") and GLOBAL.PRSI = INFLATED_BOAT) or (VERB_P("ATTACK MUNG") and FSET_P(GLOBAL.PRSI,"WEAPONBIT"))) {
        REMOVE_CAREFULLY (INFLATED_BOAT)
        MOVE (PUNCTURED_BOAT, GLOBAL.HERE)
        TELL ("It seems that the ")
        if (VERB_P("DROP PUT")) {
          TELL (GLOBAL.PRSO.alias)
        }
        else {
          TELL (GLOBAL.PRIS.alias)
        }
        msg (" didn't agree with the boat, as evidenced by the loud hissing noise issuing therefrom. With a pathetic sputter, the boat deflates, leaving you without.")
        if (FSET_P(GLOBAL.HERE, "NONLANDBIT")) {
          CRLF
          if (GLOBAL.HERE = RESERVOIR or GLOBAL.HERE = IN_STREAM) {
            JIGS_UP ("Another pathetic sputter, this time from you, heralds your drowning.")
          }
          else {
            JIGS_UP ("In other words, fighting the fierce currents of the Frigid River. You manage to hold your own for a bit, but then you are carried over a waterfall and into some nasty rocks. Ouch!")
          }
        }
        return (true)
      }
    }
    else if (VERB_P(V_LAUNCH)) {
      msg ("You're not in the boat!")
      return (true)
    }
    else if (VERB_P(V_BOARD)) {
      if (IN_P(SCEPTRE,GLOBAL.WINNER) or IN_P(KNIFE,GLOBAL.WINNER) or IN_P(SWORD,GLOBAL.WINNER) or IN_P(RUSTY_KNIFE,GLOBAL.WINNER) or IN_P(AXE,GLOBAL.WINNER) or IN_P(STILETTO,GLOBAL.WINNER)) {
        msg ("Oops! Something sharp seems to have slipped and punctured the boat. The boat deflates to the sounds of hissing, sputtering, and cursing.")
        REMOVE_CAREFULLY (INFLATED_BOAT)
        MOVE (PUNCTURED_BOAT, GLOBAL.HERE)
        THIS_IS_IT (PUNCTURED_BOAT)
        return (true)
      }
    }
    else if (VERB_P("INFLATE FILL")) {
      msg ("Inflating it further would probably burst it.")
      return (true)
    }
    else if (VERB_P(V_DEFLATE)) {
      if (LOC(GLOBAL.WINNER) = INFLATED_BOAT) {
        msg ("You can't deflate the boat while you're in it.")
      }
      else if (not IN_P(INFLATED_BOAT,GLOBAL.HERE)) {
        msg ("The boat must be on the ground to be deflated.")
      }
      else {
        msg ("The boat deflates.")
        GLOBAL.DEFLATE = true
        REMOVE_CAREFULLY (INFLATED_BOAT)
        MOVE (INFLATABLE_BOAT, GLOBAL.HERE)
        THIS_IS_IT (INFLATABLE_BOAT)
      }
      return (true)
    }
    return (false)
  </function>

  <function name="BREATHE">
    PERFORM (V_INFLATE, GLOBAL.PRSO, LUNGS)
  </function>

  <function name="IBOAT_FUNCTION" type="boolean">
    dLog ("[IBOAT_FUNCTION]")
    if (VERB_P("INFLATE FILL")) {
      if (not IN_P(INFLATABLE_BOAT, GLOBAL.HERE)) {
        msg ("The boat must be on the ground to be inflated.")
      }
      else if (GLOBAL.PRSI = PUMP) {
        msg ("The boat inflates and appears seaworthy.")
        if (not FSET_P(BOAT_LABEL,"TOUCHBIT")) {
          msg ("A tan label is lying inside the boat.")
        }
        GLOBAL.DEFLATE = false
        REMOVE_CAREFULLY (INFLATABLE_BOAT)
        MOVE (INFLATED_BOAT, GLOBAL.HERE)
        THIS_IS_IT (INFLATED_BOAT)
      }
      else if (GLOBAL.PRSI = LUNGS) {
        msg ("You don't have enough lung power to inflate it.")
      }
      else {
        msg ("With a " + GLOBAL.PRSI.alias + "? Surely you jest!")
      }
      dLog ("[IBOAT_FUNCTION] returning true")
      return (true)
    }
    dLog ("[IBOAT_FUNCTION] END OF SCRIPT - RETURNING FALSE")
    return (false)
  </function>

  <function name="RIVR4_ROOM" parameters="RARG" type="boolean">
    if (RARG = "M_END") {
      if (IN_P(BUOY,GLOBAL.WINNER) and GetBoolean(GLOBAL,"BUOY_FLAG")) {
        msg ("You notice something funny about the feel of the buoy.")
        GLOBAL.BUOY_FLAG = false
        return (true)
      }
    }
    return (false)
  </function>

  <function name="SAND_FUNCTION" type="boolean">
    if (VERB_P(V_DIG) and GLOBAL.PRSI = SHOVEL) {
      GLOBAL.BEACH_DIG = GLOBAL.BEACH_DIG + 1
      if (G_P(GLOBAL.BEACH_DIG,3)) {
        GLOBAL.BEACH_DIG = -1
        if (IN_P(SCARAB,GLOBAL.HERE)) {
          FSET (SCARAB, "INVISIBLE")
        }
        JIGS_UP ("The hole collapses, smothering you.")
      }
      else if (GLOBAL.BEACH_DIG = 3) {
        msg ("You can see a scarab here in the sand.")
        THIS_IS_IT (SCARAB)
        FCLEAR (SCARAB, "INVISIBLE")
      }
      else {
        msg (GLOBAL.BDIGS[GLOBAL.BEACH_DIG+1])
      }
      return (true)
    }
    return (false)
  </function>

  <function name="TREE_ROOM" parameters="RARG" type="boolean">
    dLog("[TREE_ROOM] ...")
    dLog("[TREE_ROOM] RARG = " + RARG)
    if (RARG = "M_LOOK") {
      msg ("You are about 10 feet above the ground nestled among some large branches. The nearest branch above you is above your reach.")
      if (not FIRST_P(PATH) = NOTHING and not NEXT_P(FIRST_P(PATH)) = NOTHING) {
        TELL ("On the ground below you can see:  ")
        PRINT_CONTENTS (PATH)
        msg (".")
      }
      return (true)
    }
    else if (RARG = "M_BEG") {
      dLog("[TREE_ROOM] GLOBAL.PRSO.name = " + GLOBAL.PRSO.name)
      if (VERB_P(V_CLIMB_DOWN) and EQUAL_P(GLOBAL.PRSO.name, "TREE ROOMS")) {
        DO_WALK ("DOWN")
        return (true)
      }
      else if (VERB_P("CLIMB_UP CLIMB_FOO") and GLOBAL.PRSO = TREE) {
        DO_WALK ("UP")
        return (true)
      }
      else if (VERB_P(V_DROP)) {
        if (not IDROP()) {
          return (true)
        }
        else if (GLOBAL.PRSO = NEST and IN_P(EGG,NEST)) {
          msg ("The nest falls to the ground, and the egg spills out of it, seriously damaged.")
          REMOVE_CAREFULLY (EGG)
          MOVE (BROKEN_EGG, PATH)
          return (true)
        }
        else if (GLOBAL.PRSO = EGG) {
          msg ("The egg falls to the ground and springs open, seriously damaged.")
          MOVE (EGG, PATH)
          BAD_EGG
          CRLF
          return (true)
        }
        else if (not GLOBAL.PRSO = GLOBAL.WINNER and not GLOBAL.PRSO = TREE) {
          MOVE (GLOBAL.PRSO, PATH)
          msg ("The " + GLOBAL.PRSO.alias + " falls to the ground.")
          return (true)
        }
        else if (VERB_P(V_LEAP)) {
          JIGS_UP ("That was just a bit too far down.")
          return (true)
        }
      }
    }
    else if (RARG = "M_ENTER") {
      ENABLE (QUEUE (I_FOREST_ROOM, -1))
    }
    return (false)
  </function>

  <function name="EGG_OBJECT" type="boolean">
    if (VERB_P("OPEN MUNG") and GLOBAL.PRSO = EGG) {
      if (FSET_P(GLOBAL.PRSO,"OPENBIT")) {
        msg ("The egg is already open.")
      }
      else if (GLOBAL.PRSI = NOTHING) {
        msg ("You have neither the tools nor the expertise.")
      }
      else if (GLOBAL.PRSI = HANDS) {
        msg ("I doubt you could do that without damaging it.")
      }
      else if (FSET_P(GLOBAL.PRSI,"WEAPONBIT") or FSET_P(GLOBAL.PRSI,"TOOLBIT") or VERB_P(V_MUNG)) {
        TELL ("The egg is now open, but the clumsiness of your attempt has seriously compromised its esthetic appeal.")
        BAD_EGG
        CRLF
      }
      else if (FSET_P(GLOBAL.PRSO,"FIGHTBIT")) {
        msg ("Not to say that using the " + GLOBAL.PRSI.alias + " isn't original too...")
      }
      else {
        msg ("The concept of using a " + GLOBAL.PRSI.alias + " is certainly original.")
        FSET (GLOBAL.PRSO, "FIGHTBIT")
      }
      return (true)
    }
    else if (VERB_P("CLIMB_ON HATCH")) {
      TELL ("There is a noticeable crunch from beneath you, and inspection reveals that the egg is lying open, badly damaged.")
      BAD_EGG
      CRLF
      return (true)
    }
    else if (VERB_P("OPEN MUNG THROW")) {
      if (VERB_P(V_THROW)) {
        MOVE (GLOBAL.PRSO, GLOBAL.HERE)
      }
      TELL ("Your rather indelicate handling of the egg has caused it some damage, although you have succeeded in opening it.")
      BAD_EGG
      CRLF
      return (true)
    }
    return (false)
  </function>

  <function name="BAD_EGG"><![CDATA[
    if (IN_P(CANARY,EGG)) {
      msg ("&nbsp;" + BROKEN_CANARY.FDESC)
    }
    else {
      REMOVE_CAREFULLY (BROKEN_CANARY)
    }
    MOVE (BROKEN_EGG, LOC(EGG))
    REMOVE_CAREFULLY (EGG)
    return (true)
  ]]></function>

  <function name="CANARY_OBJECT" type="boolean">
    if (VERB_P(V_WIND)) {
      if (GLOBAL.PRSO = CANARY) {
        if (not GLOBAL.SING_SONG and FOREST_ROOM_P()) {
          msg ("The canary chirps, slightly off-key, an aria from a forgotten opera. From out of the greenery flies a lovely songbird. It perches on a limb just over your head and opens its beak to sing. As it does so a beautiful brass bauble drops from its mouth, bounces off the top of your head, and lands glimmering in the grass. As the canary winds down, the songbird flies away.")
          GLOBAL.SING_SONG = true
          if (GLOBAL.HERE = UP_A_TREE) {
            dest = PATH
          }
          else {
            dest = GLOBAL.HERE
          }
          MOVE (BAUBLE, dest)
        }
        else {
          msg ("The canary chirps blithely, if somewhat tinnily, for a short time.")
        }
      }
      else {
        msg ("There is an unpleasant grinding noise from inside the canary.")
      }
      return (true)
    }
    return (false)
  </function>

  <function name="FOREST_ROOM_P" type="boolean">
    return (EQUAL_P(GLOBAL.HERE.name,"FOREST_1 FOREST_2 FOREST_3 PATH UP_A_TREE"))
  </function>

  <turnscript name="I_FOREST_ROOM">
    <script>
      if (not FOREST_ROOM_P()) {
        DISABLE (I_FOREST_ROOM)
      }
      else if (PROB(15)) {
        msg ("You hear in the distance the chirping of a song bird.")
      }
    </script>
  </turnscript>

  <function name="FOREST_ROOM" parameters="RARG" type="boolean">
    if (RARG = "M_ENTER") {
      ENABLE (QUEUE (I_FOREST_ROOM,-1))
    }
    else if (RARG = "M_BEG") {
      if ((VERB_P(V_CLIMB_FOO) or VERB_P(V_CLIMB_UP)) and GLOBAL.PRSO = TREE) {
        DO_WALK ("up")
        return (true)
      }
    }
    return (false)
  </function>

  <function name="WCLIF_OBJECT" type="boolean">
    if (VERB_P("CLIMB_UP CLIMB_DOWN CLIMB_FOO")) {
      msg ("The cliff is too steep for climbing.")
      return (true)
    }
    return (false)
  </function>

  <function name="CLIFF_OBJECT" type="boolean">
    if (VERB_(V_LEAP) or (VERB_P(V_PUT) and GLOBAL.PRSO = ME)) {
      msg ("That would be very unwise. Perhaps even fatal.")
      return (true)
    }
    else if (GLOBAL.PRSI = CLIMBABLE_CLIFF) {
      if (VERB_P("PUT THROW_OFF")) {
        msg ("The " + GLOBAL.PRSO.alias + " tumbles into the river and is seen no more.")
        REMOVE_CAREFULLY (GLOBAL.PRSO)
        return (true)
      }
    }
    return (false)
  </function>

  <function name="ROPE_FUNCTION" type="boolean">
    if (not GLOBAL.HERE = DOME_ROOM) {
      GLOBAL.DOME_FLAG = false
      if (VERB_P(V_TIE)) {
        msg ("You can't tie the rope to that.")
        return (true)
      }
    }
    else if (VERB_P(V_TIE)) {
      if (GLOBAL.PRSI = RAILING) {
        if (GLOBAL.DOME_FLAG) {
          msg ("The rope is already tied to it.")
        }
        else {
          msg ("The rope drops over the side and comes within ten feet of the floor.")
          GLOBAL.DOME_FLAG = true
          FSET (ROPE, "NDESCBIT")
          RLOC = LOC(ROPE)
          if (RLOC = NOTHING or not GetBoolean(RLOC,"isroom")) {
            MOVE (ROPE, GLOBAL.HERE)
          }
          return (true)
        }
        return (true)
      }
    }
    else if (VERB_P(V_CLIMB_DOWN) and EQUAL_P(GLOBAL.PRSO.name,"ROPE ROOMS") and GetBoolean(GLOBAL,"DOME_FLAG")) {
      DO_WALK ("DOWN")
      return (true)
    }
    else if (VERB_P(V_TIE_UP) and ROPE = GLOBAL.PRSI) {
      if (FSET_P(GLOBAL.PRSO,"ACTORBIT")) {
        if (L_P(GLOBAL.PRSO.STRENGTH,0)) {
          msg ("Your attempt to tie up the " + GLOBAL.PRSO.alias + " awakens him.")
          AWAKEN (GLOBAL.PRSO)
        }
        else {
          msg ("The " + GLOBAL.PRSO.alias + " struggles and you cannot tie him up.")
        }
      }
      else {
        msg ("Why would you tie up a " + GLOBAL.PRSO.alias + "?")
      }
      return (true)
    }
    else if (VERB_P(V_UNTIE)) {
      if (GLOBAL.DOME_FLAG) {
        GLOBAL.DOME_FLAG = false
        FCLEAR (ROPE, "NDESCBIT")
        msg ("The rope is now untied.")
      }
      else {
        msg ("It is not tied to anything.")
      }
      return (true)
    }
    else if (VERB_P(V_DROP) and GLOBAL.HERE = DOME_ROOM and not GetBoolean(GLOBAL,"DOME_FLAG")) {
      MOVE (ROPE, TORCH_ROOM)
      msg ("The rope drops gently to the floor below.")
      return (true)
    }
    else if (VERB_P(V_TAKE)) {
      if (GLOBAL.DOME_FLAG) {
        msg ("The rope is tied to the railing.")
        return (true)
      }
    }
    return (false)
  </function>

  <function name="UNTIE_FROM" type="boolean">
    if (GLOBAL.PRSO = ROPE and GLOBAL.DOME_FLAG and GLOBAL.PRSI = RAILING) {
      PERFORM (V_UNTIE, GLOBAL.PRSO, NOTHING)
    }
    else {
      msg ("It's not attached to that!")
    }
    return (true)
  </function>

  <function name="SLIDE_FUNCTION" type="boolean">
    if (VERB_P("THROUGH CLIMB_UP CLIMB_DOWN CLIMB_FOO") or (VERB_P(V_PUT) and GLOBAL.PRSO = ME)) {
      if (GLOBAL.HERE = CELLAR) {
        DO_WALK ("WEST")
        return (true)
      }
      else {
        msg ("You tumble down the slide....")
        GOTO (CELLAR, true)
        return (true)
      }
    }
    else if (VERB_P(V_PUT)) {
      SLIDER (GLOBAL.PRSO)
      return (true)
    }
    return (false)
  </function>

  <function name="SLIDER" parameters="OBJ">
    if (FSET_P(OBJ,"TAKEBIT")) {
      msg ("The " + OBJ.alias + " falls into the slide and is gone.")
      if (OBJ = WATER) {
        REMOVE_CAREFULLY (OBJ)
      }
      else {
        MOVE (OBJ, CELLAR)
      }
    }
    else {
      msg (PICK_ONE(GLOBAL.YUKS))
    }
  </function>

  <function name="SANDWICH_BAG_FCN" type="boolean">
    if (VERB_P(V_SMELL) and IN_P(LUNCH,GLOBAL.PRSO)) {
      msg ("It smells of hot peppers.")
      return (true)
    }
    return (false)
  </function>

  <function name="DEAD_FUNCTION" parameters="FOO">
    if (not IsDefined("FOO")) {
      FOO = false
    }
    switch (GLOBAL.PRSA) {
      case (V_WALK) {
        if (GLOBAL.HERE = TIMBER_ROOM and GLOBAL.PRSO_DIR = "WEST") {
          msg ("You cannot enter in your condition.")
        }
      }
      case (V_BRIEF,V_VERBOSE,V_SUPER_BRIEF,V_VERSION,V_SAVE,V_RESTORE,V_QUIT,V_RESTART) {
        return (false)
      }
      case (V_ATTACK,V_MUNG,V_ALARM,V_SWING) {
        msg ("All such attacks are vain in your condition.")
      }
      case (V_OPEN,V_CLOSE,V_EAT,V_DRINK,V_INFLATE,V_DEFLATE,V_TURN,V_BURN,V_TIE,V_UNTIE,V_RUB) {
        msg ("Even such an action is beyond your capabilities.")
      }
      case (V_WAIT) {
        msg ("Might as well. You've got an eternity.")
      }
      case (V_LAMP_ON) {
        msg ("You need no light to guide you.")
      }
      case (V_SCORE) {
        msg ("You're dead! How can you think of your score?")
      }
      case (V_TAKE) {
        msg ("Your hand passes through its object.")
      }
      case (V_DROP,V_THROW,V_INVENTORY) {
        msg ("You have no possessions.")
      }
      case (V_DIAGNOSE) {
        msg ("You are dead.")
      }
      case (V_LOOK) {
        TELL ("The room looks strange and unearthly")
        if (FIRST_P(GLOBAL.HERE) = NOTHING) {
          TELL (".")
        }
        else {
          TELL (" and objects appear indistinct.")
        }
        CRLF
        if (not FSET_P(GLOBAL.HERE,"ONBIT")) {
          msg ("Although there is no light, the room seems dimly illuminated.")
        }
        CRLF
        return (false)
      }
      case (V_PRAY) {
        if (GLOBAL.HERE = SOUTH_TEMPLE) {
          FCLEAR (LAMP, "INVISIBLE")
          dLog ("DEAD_FUNCTION - case(PRAY) setting GLOBAL.WINNER.ACTION to null!")
          GLOBAL.WINNER.ACTION = null
          GLOBAL.ALWAYS_LIT = false
          GLOBAL.DEAD = false
          if (IN_P(TROLL,TROLL_ROOM)) {
            GLOBAL.TROLL_FLAG = false
          }
          msg ("From the distance the sound of a lone trumpet is heard. The room becomes very bright and you feel disembodied. In a moment, the brightness fades and you find yourself rising as if from a long sleep, deep in the woods. In the distance you can faintly hear a songbird and the sounds of the forest.\r\n")
          GOTO (FOREST_1, true)
        }
        else {
          msg ("Your prayers are not heard.")
        }
      }
      default {
        msg ("You can't even do that.")
        GLOBAL.P_CONT = 0
        RFATAL
      }
    }
    // TODO - Quest saved this script with an extra } at the end
  </function>

  <function name="LAKE_PSEUDO" type="boolean">
    if (GLOBAL.LOW_TIDE) {
      msg ("There's not much lake left....")
      return (true)
    }
    else if (VERB_P(V_CROSS)) {
      msg ("It's too wide to cross.")
      return (true)
    }
    else if (VERB_P(V_THROUGH)) {
      msg ("You can't swim in this lake.")
      return (true)
    }
    return (false)
  </function>

  <function name="STREAM_PSEUDO" type="boolean">
    if (VERB_P("SWIM THROUGH")) {
      msg ("You can't swim in the stream.")
      return (true)
    }
    else if (VERB_P(V_CROSS)) {
      msg ("The other side is a sheer rock cliff.")
      return (true)
    }
    return (false)
  </function>

  <function name="CHASM_PSEUDO" type="boolean">
    if (VERB_P(V_LEAP) or (VERB_P(V_PUT) and GLOBAL.PRSO = ME)) {
      msg ("You look before leaping, and realize that you would never survive.")
      return (true)
    }
    else if (VERB_P(V_CROSS)) {
      msg ("It's too far to jump, and there's no bridge.")
      return (true)
    }
    else if (VERB_P("PUT THROW_OFF") and GLOBAL.PRSI = PSEUDO_OBJECT) {
      msg ("The " + GLOBAL.PRSO.alias + " drops out of sight into the chasm.")
      REMOVE_CAREFULLY (GLOBAL.PRSO)
      return (true)
    }
    return (false)
  </function>

  <function name="DOME_PSEUDO" type="boolean">
    if (VERB_P(V_KISS)) {
      msg ("No.")
      return (true)
    }
    return (false)
  </function>

  <function name="GATE_PSEUDO" type="boolean">
    if (VERB_P(V_THROUGH)) {
      DO_WALK ("IN")
    }
    else {
      msg ("The gate is protected by an invisible force. It makes your teeth ache to touch it.")
    }
    return (true)
  </function>

  <function name="DOOR_PSEUDO" type="boolean">
    if (VERB_P("OPEN CLOSE")) {
      msg ("The door won't budge.")
      return (true)
    }
    else if (VERB_P(V_THROUGH)) {
      DO_WALK ("SOUTH")
      return (true)
    }
    return (false)
  </function>

  <function name="PAINT_PSEUDO" type="boolean">
    if (VERB_P(V_MUNG)) {
      msg ("Some paint chips away, revealing more paint.")
      return (true)
    }
    return (false)
  </function>

  <function name="GAS_PSEUDO" type="boolean">
    if (VERB_P(V_BREATHE)) {
      msg ("There is too much gas to blow away.")
      return (true)
    }
    else if (VERB_P(V_SMELL)) {
      msg ("It smells like coal gas in here.")
      return (true)
    }
    return (false)
  </function>

  <function name="DO_FIGHT" parameters="LEN">
  //LEN = LEN - 1 // not using the first element
    fLog("[DO_FIGHT] LEN = " + LEN)
    OUT = 0
    CNT = 0
    foreach(OO,GLOBAL.VILLAINS){
      CNT = CNT + 1
      if (CNT = 1){
        fLog("[DO_FIGHT] CNT is 1; doing nothing")
        // do nothing
      }
      else {
        if (CNT = LEN) {
          fLog("[DO_FIGHT] CNT = LEN; returning null")
          return(null)
        }
        O = ListItem(OO,GLOBAL.V_VILLAIN)
        fLog("[DO_FIGHT] O is " + O)
        //RES = VILLAIN_BLOW(OO,OUT)
        //fLog("[DO_FIGHT] VILLAIN_BLOW returned " + RES)
        if (not FSET_P(O,"FIGHTBIT")) {
          fLog("[DO_FIGHT] " + O.name +" FIGHTBIT not set")
          // do nothing
        }
        else if (EvalToBoolean(O.ACTION + "(GLOBAL.F_BUSY_P)")) {
          fLog("[DO_FIGHT] " + O.name + " ACTION(F_BUSY_P) returned true")
          // do nothing
        }
        else {
          RES = VILLAIN_BLOW(OO,OUT)
          fLog("[DO_FIGHT] VILLAIN_BLOW returned " + RES)
          if (not RES > 0) {
            fLog("[DO_FIGHT] VILLAIN_BLOW is less than 1; returning null")
            RES = 0
            return (null)
          }
          else if (RES = GLOBAL.UNCONSCIOUS) {
            fLog("[DO_FIGHT] RES = UNCONSCIOUS")
            OUT = RANDOM(3) + 1
          }
          if (not RES > 0) {
            fLog("[DO_FIGHT] RES less than 1")
            if (not OUT > 0) {
              fLog("[DO_FIGHT] OUT less than 1, returning null")
              return (null)
            }
            else {
              fLog("[DO_FIGHT] OUT >= 1; subtracting 1")
              OUT = OUT - 1
              if (OUT = 0) {
                fLog("[DO_FIGHT] OUT is now 0; returning null")
                return (null)
              }
            }
          }
          else {
            fLog("[DO_FIGHT] end of foreach, returning null")
            return (null)
          }
        }
      }
    }
  </function>

  <function name="REMARK" parameters="REMARK, D, W">
    REMARK = Replace(REMARK,"F-DEF",D.alias)
    REMARK = Replace(REMARK,"F-WEP",W.alias)
    msg (REMARK)
  </function>

  <function name="FIGHT_STRENGTH" parameters="ADJUST_P" type="int">
    if (not IsDefined("ADJUST_P")) {
      ADJUST_P = true
    }
    S = GLOBAL.STRENGTH_MIN + (GLOBAL.SCORE / (GLOBAL.SCORE_MAX / (GLOBAL.STRENGTH_MAX - GLOBAL.STRENGTH_MIN)))
    if (ADJUST_P) {
      return (S + GLOBAL.WINNER.STRENGTH)
    }
    else {
      return (S)
    }
  </function>

  <function name="VILLAIN_STRENGTH" parameters="OO" type="int">
    fLog ("[VILLAIN_STRENGTH]")
    //fLog("VILLAIN_STRENGTH OO is " + OO)
    v_best_adv = OO[GLOBAL.V_BEST_ADV]
    fLog ("[VILLAIN_STRENGTH] v_best_adv: " + v_best_adv)
    VILLAIN = ListItem(OO, GLOBAL.V_VILLAIN)
    fLog ("[VILLAIN_STRENGTH] VILLAIN: " + VILLAIN)
    OD = VILLAIN.STRENGTH
    fLog ("[VILLAIN_STRENGTH] OD = " + OD)
    if (not L_P(OD,0)) {
      if (VILLAIN = THIEF and GLOBAL.THIEF_ENGROSSED) {
        if (G_P(OD,2)) {
          OD = 2
        }
        GLOBAL.THIEF_ENGROSSED = false
      }
    }
    if (not GLOBAL.PRSI = NOTHING and FSET_P(GLOBAL.PRSI,"WEAPONBIT") and OO[GLOBAL.V_BEST] = GLOBAL.PRSI) {
      fLog("[VILLAIN_BLOW] weapon is V_BEST")
      TMP = OD - v_best_adv
      if (L_P(TMP,1)) {
        TMP = 1
      }
      OD = TMP
    }
    return (OD)
  </function>

  <function name="FIND_WEAPON" parameters="O" type="object">
    W = NOTHING
    foreach(obj,GetDirectChildren(O)){
      if (EQUAL_P(obj.name,"STILETTO AXE SWORD KNIFE RUSTY_KNIFE")) {
        return (obj)
      }
    }
    //W = FIRST_P(O)
    //if (W = NOTHING) {
    //  return (NOTHING)
    //}
    //exitwhile = false
    //while (not exitwhile) {
    //  if (EQUAL_P(W.name,"STILETTO AXE SWORD") or W = KNIFE or W = RUSTY_KNIFE) {
    //    return (W)
    //  }
    //  else if (NEXT_P(W) = NOTHING) {
    //    exitwhile = true
    //  }
    //}
    return (NOTHING)
  </function>

  <function name="VILLAIN_BLOW" parameters="OO, OUT_P" type="int">
    fLog("[VILLAIN_BLOW]...")
    fLog("[VILLAIN_BLOW] OUT_P: " + OUT_P)
    VILLAIN = OO[GLOBAL.V_VILLAIN]
    fLog("[VILLAIN_BLOW] VILLAIN = " + VILLAIN)
    REMARKS = OO[GLOBAL.V_MSGS]
    FCLEAR (GLOBAL.WINNER, "STAGGERED")
    if (FSET_P(VILLAIN,"STAGGERED")) {
      msg ("The " + VILLAIN.alias + " slowly regains his feet.")
      FCLEAR (VILLAIN, "STAGGERED")
      return (1)
    }
    ATT = VILLAIN_STRENGTH(OO)
    fLog("[VILLAIN_BLOW] ATT = " + ATT)
    OA = ATT
    DEF = FIGHT_STRENGTH(true)
    fLog("[VILLAIN_BLOW] DEF = " + DEF)
    if (not G_P(DEF,0)) {
      fLog("[VILLAIN_BLOW] DEF less than 1; returning true")
      return (1)
    }
    OD = FIGHT_STRENGTH(false)
    fLog("[VILLAIN_BLOW] OD = " + OD)
    DWEAPON = FIND_WEAPON(GLOBAL.WINNER)
    fLog("[VILLAIN_BLOW] DWEAPON = " + DWEAPON.name)
    if (L_P(DEF,0)) {
      fLog("[VILLAIN_BLOW] RES = GLOBAL.KILLED!")
      RES = GLOBAL.KILLED
    }
    else {
      if (DEF = 1) {
        if (G_P(ATT,2)) {
          ATT = 3
        }
        TBL = GLOBAL.DEF1_RES[ATT-1]
      }
      else if (DEF = 2) {
        if (G_P(ATT,3)) {
          ATT = 4
        }
        TBL = GLOBAL.DEF2_RES[ATT-1]
      }
      else if (G_P(DEF,2)) {
        ATT = ATT - DEF
        if (L_P(ATT,-1)) {
          ATT = -2
        }
        else if (G_P(ATT,1)) {
          ATT = 2
        }
        TBL = GLOBAL.DEF3_RES[ATT + 2]
      }
      RES = TBL[RANDOM(9) - 1]
      fLog("[VILLAIN_BLOW] RES: " + RES)
      if (OUT_P > 0) {
        fLog("[VILLAIN_BLOW] OUT_P (" + OUT_P + ") is greater than 0...")
        if (RES = GLOBAL.STAGGER) {
          fLog("[VILLAIN_BLOW] RES = STAGGER (" + RES + "); changing to HESITATE (" + GLOBAL.HESITATE + ")")
          RES = GLOBAL.HESITATE
        }
        else {
          fLog("[VILLAIN_BLOW] RES not = STAGGER (" + RES + "); changing to SITTING_DUCK (" + GLOBAL.SITTING_DUCK + ")")
          RES = GLOBAL.SITTING_DUCK
        }
      }
      //if (HERO_P) {
      //  n = 10
      //}
      //else {
        n = 50
      //}
      if (RES = GLOBAL.STAGGER and not DWEAPON = NOTHING and PROB(25,n)) {
        RES = GLOBAL.LOSE_WEAPON
        fLog("[VILLAIN_BLOW] STAGGER and no DWEAPON and PROB(25,50); set RES to " + RES)
      }
      fLog("[VILLAIN_BLOW] calling REMARK")
      REMARK (RANDOM_ELEMENT(REMARKS[RES-1]), GLOBAL.WINNER, DWEAPON)
    }
    if (RES = GLOBAL.MISSED or RES = GLOBAL.HESITATE) {
      fLog("[VILLAIN_BLOW] MISSED or HESITATE; do nothing")
      // do nothing
    }
    else if (RES = GLOBAL.UNCONSCIOUS) {
      fLog("[VILLAIN_BLOW] UNCONSCIOUS; do nothing")
      // do nothing
    }
    else if (RES = GLOBAL.KILLED or RES = GLOBAL.SITTING_DUCK) {
      fLog("[VILLAIN_BLOW] res = killed")
      DEF = 0
    }
    else if (RES = GLOBAL.LIGHT_WOUND) {
      DEF = DEF - 1
      if (L_P(DEF,0)) {
        DEF = 0
      }
      if (G_P(GLOBAL.LOAD_ALLOWED,50)) {
        GLOBAL.LOAD_ALLOWED = GLOBAL.LOAD_ALLOWED - 10
      }
    }
    else if (RES = GLOBAL.SERIOUS_WOUND) {
      DEF = DEF - 2
      if (L_P(DEF,0)) {
        DEF = 0
      }
      if (G_P(GLOBAL.LOAD_ALLOWED,50)) {
        GLOBAL.LOAD_ALLOWED = GLOBAL.LOAD_ALLOWED - 20
      }
    }
    else if (RES = GLOBAL.STAGGER) {
      FSET (GLOBAL.WINNER, "STAGGERED")
    }
    else {
      MOVE (DWEAPON, GLOBAL.HERE)
      NWEAPON = FIND_WEAPON(GLOBAL.WINNER)
      if (not NWEAPON = NOTHING) {
        msg ("Fortunately, you still have a " + NWEAPON.alias + ".")
      }
    }
    fLog("[VILLAIN_BLOW] returning WINNER_RESULT(DEF,RES,OD)")
    return (WINNER_RESULT(DEF,RES,OD))
  </function>

  <function name="HERO_BLOW" type="boolean">
    fLog("[HERO_BLOW] ...")
    OUT_P = false
    OO = NOTHING
    CNT = 0
    foreach(v,GLOBAL.VILLAINS){
      CNT = CNT + 1
      if (CNT = 1){
        //do nothing
      }
      else {
         if (v[0] = GLOBAL.PRSO){
            OO = v
          }
        }
    }
    if (OO = NOTHING){
      error ("HERO_BLOW could not find a result in VILLAINS!")
    }
    //fLog("[HERO_BLOW] OO is " + OO)
    FSET (GLOBAL.PRSO, "FIGHTBIT")
    if (FSET_P(GLOBAL.WINNER,"STAGGERED")) {
      msg ("You are still recovering from that last blow, so your attack is ineffective.")
      FCLEAR (GLOBAL.WINNER, "STAGGERED")
      return (true)
    }
    ATT = FIGHT_STRENGTH(true)
    if (L_P(ATT,1)) {
      ATT = 1
    }
    OA = ATT
    VILLAIN = OO[GLOBAL.V_VILLAIN]
    fLog("[HERO_BLOW] VILLAIN is " + VILLAIN)
    DEF = VILLAIN_STRENGTH(OO)
    OD = DEF
    fLog("[HERO_BLOW] VILLAIN strength (both DEF and OD) is " + OD)
    if (OD = 0) {
      if (GLOBAL.PRSO = GLOBAL.WINNER) {
        // return (JIGS_UP("Well, you really did it that time. Is suicide painless?"))
        JIGS_UP ("Well, you really did it that time. Is suicide painless?")
        return (true)
      }
      msg ("Attacking the " + VILLAIN.alias + " is pointless.")
      return (true)
    }
    DWEAPON = FIND_WEAPON(VILLAIN)
    fLog("[HERO_BLOW] DWEAPON = " + DWEAPON.name)
    if (DWEAPON = NOTHING or L_P(DEF,0)) {
      TELL ("The ")
      if (L_P(DEF,0)) {
        TELL ("unconscious")
      }
      else {
        TELL ("unarmed")
      }
      msg (" " + VILLAIN.alias + " cannot defend himself: He dies.")
      RES = GLOBAL.KILLED
      //fLog("[HERO_BLOW] Removing OO from GLOBAL.VILLAINS. Before:")
      //fLog(GLOBAL.VILLAINS)
      list remove (GLOBAL.VILLAINS, OO)
      fLog("[HERO_BLOW] Removed OO from GLOBAL.VILLAINS.")
      //fLog(GLOBAL.VILLAINS)
      fLog("[HERO_BLOW] " + VILLAIN.name + " has died; RES = KILLED")
    }
    else {
      if (DEF = 1) {
        if (G_P(ATT,2)) {
          ATT = 3
        }
        TBL = GLOBAL.DEF1_RES[ATT-2]
      }
      else if (DEF = 2) {
        if (G_P(ATT,3)) {
          ATT = 4
        }
        TBL = GLOBAL.DEF2_RES[ATT-2]
      }
      else if (G_P(DEF,2)) {
        ATT = ATT - DEF
        if (L_P(ATT,-1)) {
          ATT = -2
        }
        else if (G_P(ATT,1)) {
          ATT = 2
        }
        TBL = GLOBAL.DEF2_RES[ATT + 1]
      }
      THIS_INT = RANDOM(9)-1
      fLog("THIS_INT: " + THIS_INT)
      RES = TBL[THIS_INT]
      if (OUT_P) {
        fLog("[HERO_BLOW] OUT_P is TRUE")
        if (RES = GLOBAL.STAGGER) {
          fLog("[HERO_BLOW] RES = STAGGER; changing to HESITATE ("+GLOBAL.HESITATE+")")
          RES = GLOBAL.HESITATE
        }
        else {
          fLog("[HERO_BLOW] RES = STAGGER; changing to SITTING_DUCK (" + GLOBAL.SITTING_DUCK + ")")
          RES = GLOBAL.SITTING_DUCK
        }
      }
      if (RES = GLOBAL.STAGGER and not DWEAPON = NOTHING and PROB(25)) {
        fLog("[HERO_BLOW] STAGGER and no DWEAPON and PROB(25); changing RES TO LOSE_WEAPON (" + GLOBAL.LOSE_WEAPON + ")")
        RES = GLOBAL.LOSE_WEAPON
      }
      fLog("[HERO_BLOW] calling REMARK")
      REMARK (RANDOM_ELEMENT(GLOBAL.HERO_MELEE[RES - 1]), GLOBAL.PRSO, GLOBAL.PRSI)
    }
    if (RES = GLOBAL.MISSED or RES = GLOBAL.HESITATE) {
      fLog("[HERO_BLOW] MISSED or HESITATE; do nothing")
      // do nothing
    }
    else if (RES = GLOBAL.UNCONSCIOUS) {
      DEF = 0 - DEF
    }
    else if (RES = GLOBAL.KILLED or RES = GLOBAL.SITTING_DUCK) {
      fLog("[HERO_BLOW] RES = KILLED or SITTING_DUCK; setting DEF to 0")
      DEF = 0
    }
    else if (RES = GLOBAL.LIGHT_WOUND) {
      DEF = DEF - 1
      if (L_P(DEF,0)) {
        DEF = 0
      }
    }
    else if (RES = GLOBAL.SERIOUS_WOUND) {
      DEF = DEF - 2
      if (L_P(DEF,0)) {
        DEF = 0
      }
    }
    else if (RES = GLOBAL.STAGGER) {
      fLog("[HERO_BLOW] STAGGER; set PRSO 'STAGGERED' flag")
      FSET (GLOBAL.PRSO, "STAGGERED")
    }
    else {
      fLog("[HERO_BLOW] last else; moving DWEAPON HERE")
      FCLEAR (DWEAPON, "NDESCBIT")
      FSET (DWEAPON, "WEAPONBIT")
      MOVE (DWEAPON, GLOBAL.HERE)
      THIS_IS_IT (DWEAPON)
    }
    fLog("[HERO_BLOW] ends; returning VILLAIN_RESULT(" + GLOBAL.PRSO.name + "," + DEF + "," + RES + ")")
    return (VILLAIN_RESULT(GLOBAL.PRSO,DEF,RES))
  </function>

  <function name="WINNER_RESULT" parameters="DEF, RES, OD" type="int">
    if (DEF = 0) {
      GLOBAL.WINNER.STRENGTH = -10000
    }
    else {
      GLOBAL.WINNER_STRENGTH = DEF - OD
    }
    if (L_P(DEF-OD, 0)) {
      ENABLE (QUEUE(I_CURE,GLOBAL.CURE_WAIT))
    }
    if (not G_P(FIGHT_STRENGTH(true),0)) {
      GLOBAL.WINNER.STRENGTH = 0 - FIGHT_STRENGTH(false) + 1
      JIGS_UP ("It appears that that last blow was too much for you. I'm afraid you are dead.")
      return (false)
    }
    return (RES)
  </function>

  <function name="VILLAIN_RESULT" parameters="VILLAIN, DEF, RES" type="int">
    fLog("[VILLAIN_RESULT]")
    fLog("[VILLAIN_RESULT] VILLAIN: "  + VILLAIN)
    fLog("[VILLAIN_RESULT] DEF: " + DEF)
    fLog("[VILLAIN_RESULT] RES: " + RES)
    VILLAIN.STRENGTH = DEF
    if (DEF = 0) {
      fLog("[VILLAIN_RESULT] DEF = 0; killing " + VILLAIN.name + "!")
      FCLEAR (VILLAIN, "FIGHTBIT")
      msg ("Almost as soon as the " + VILLAIN.alias + " breathes his last breath, a cloud of sinister black fog envelops him, and when the fog lifts, the carcass has disappeared.")
      //fLog("[VILLAIN_RESULT] calling REMOVE_CAREFULLY(" + VILLAIN.name + ")")
      //REMOVE_CAREFULLY (VILLAIN)
      fLog("[VILLAIN_RESULT] calling " + VILLAIN.name + ".ACTION(F_DEAD)")
      pippo = Eval(VILLAIN.ACTION + "(GLOBAL.F_DEAD)")
      fLog("[VILLAIN_RESULT] calling REMOVE_CAREFULLY(" + VILLAIN.name + ")")
      REMOVE_CAREFULLY (VILLAIN)
      fLog("[VILLAIN_RESULT] " + VILLAIN.name + " is now dead, dead, dead; returning RES (" + RES + ")")
      return (RES)
    }
    else if (RES = GLOBAL.UNCONSCIOUS) {
      fLog("[VILLAIN_RESULT] calling " + VILLAIN.name + ".ACTION(F_UNCONCSCIOUS)")
      pippo = Eval(VILLAIN.ACTION + "(GLOBAL.F_UNCONSCIOUS)")
      fLog("[VILLAIN_RESULT] " + VILLAIN.name + " is now UNCONSCIOUS; returning RES (" + RES + ")")
      return (RES)
    }
    else {
      fLog("[VILLAIN_RESULT] else; returning RES (" + RES + ")")
      return (RES)
    }
  </function>

  <function name="WINNING_P" parameters="V" type="boolean"><![CDATA[
    VS = V.STRENGTH
    PS = VS - FIGHT_STRENGTH(true)
    if (PS > 3) {
      return (PROB(90))
    }
    else if (PS > 0) {
      return (PROB(75))
    }
    else if (PS = 0) {
      return (PROB(50))
    }
    else if (VS > 1) {
      return (PROB(25))
    }
    else {
      return (PROB(10))
    }
  ]]></function>

  <turnscript name="I_CURE">
    <script><![CDATA[
      S = GLOBAL.WINNER.STRENGTH
      if (S > 0) {
        S = 0
        GLOBAL.WINNER.STRENGTH = S
      }
      else if (S < 0) {
        S = S + 1
        GLOBAL.WINNER.STRENGTH = S
      }
      if (S < 0) {
        if (L_P(GLOBAL.LOAD_ALLOWED,GLOBAL.LOAD_MAX)) {
          GLOBAL.LOAD_ALLOWED = GLOBAL.LOAD_ALLOWED + 10
        }
        ENABLE (QUEUE (I_CURE, GLOBAL.CURE_WAIT))
      }
      else {
        GLOBAL.LOAD_ALLOWED = GLOBAL.LOAD_MAX
        DISABLE (I_CURE)
      }
    ]]></script>
  </turnscript>

  <turnscript name="I_FIGHT">
    <script>
      fLog ("[I_FIGHT] ...")
      FIGHT_P = false
      LEN = ListCount(GLOBAL.VILLAINS)
      fLog ("[I_FIGHT] LEN = " + LEN)
      if (GLOBAL.DEAD) {
        return (false)
      }
      CNT = 0
      foreach(OO,GLOBAL.VILLAINS){
        CNT = CNT + 1
        fLog ("[I_FIGHT] CNT = " + CNT)
        if (CNT = 1){
          //do nothing
          fLog ("[I_FIGHT] CNT = 1; doing nothing")
        }
        else if (CNT = LEN){
          RES = 1
          //fLog ("[I_FIGHT] CNT = LEN; setting RES to (" + RES +")")
          //return (RES)
          fLog ("[I_FIGHT] CNT = LEN; set RES to 1; doing nothing")
          // do nothing
        }
        else {
          O = OO[GLOBAL.V_VILLAIN]
          fLog("[I_FIGHT] O: " + O)
          if (O = null) {
            fLog("[I_FIGHT] O is null. Returning false.")
            return (false)
          }
          if (IN_P(O,GLOBAL.HERE) and not FSET_P(O,"INVISIBLE")) {
            fLog("[I_FIGHT] O (" + O.name + ") is HERE and not INVISIBLE.")
            if (O = THIEF and GLOBAL.THIEF_ENGROSSED) {
              fLog ("[I_FIGHT] O is the THIEF, and THIEF_ENGROSSED is True")
              fLog ("[I_FIGHT] setting THIEF_ENGROSSED to False")
              GLOBAL.THIEF_ENGROSSED = false
            }
            else if (L_P(O.STRENGTH,0)) {
              fLog ("[I_FIGHT] O.STRENGTH is less than 0")
              P = OO[GLOBAL.V_PROB]
              fLog ("[I_FIGHT] P = " + P)
              if (not P = 0 and PROB(P)) {
                fLog ("[I_FIGHT] P is not 0 and PROB(P) returned True")
                fLog ("[I_FIGHT] Putting 0 for GLOBAL.V_PROB of OO")
                PUT (OO, GLOBAL.V_PROB, 0)
                fLog ("[I_FIGHT] calling AWAKEN(" + O.name + ")")
                AWAKEN (O)
              }
              else {
                fLog ("[I_FIGHT] putting P + 25 for GLOBAL.V_PROB of OO")
                PUT (OO, GLOBAL.V_PROB, P + 25)
              }
            }
            else if (FSET_P(O,"FIGHTBIT") or EvalToBoolean(O.ACTION + "(GLOBAL.F_FIRST_P )")) {
              fLog ("[I_FIGHT] " + O.name + " has FIGHTBIT set or ACTION(GLOBAL.F_FIRST_P) returned true; setting FIGHT_P to True")
              if (FSET_P(O,"FIGHTBIT")){
                fLog ("[I_FIGHT] (definitely FIGHTBIT)")
              }
              FIGHT_P = true
            }
          }
          else {
            if (FSET_P(O,"FIGHBIT")) {
              fLog ("[I_FIGHT] " + O.name + " has FIGHTBIT set! calling O's ACTION(F_BUSY_P)")
              pippo = EvalToBoolean (O.ACTION + "(GLOBAL.F_BUSY_P)")
            }
            if (O = THIEF) {
              fLog ("[I_FIGHT] O is the thief; clearing THIEF_ENGROSSED")
              GLOBAL.THIEF_ENGROSSED = false
            }
            fLog ("[I_FIGHT] clearing staggered, and fightbit")
            FCLEAR (GLOBAL.WINNER, "STAGGERED")
            FCLEAR (O, "STAGGERED")
            FCLEAR (O, "FIGHTBIT")
            fLog ("[I_FIGHT] calling AWAKEN(O)")
            AWAKEN (O)
          }
        }
      }
      fLog ("[I_FIGHT] checking FIGHT_P...")
      if (not FIGHT_P) {
        fLog ("[I_FIGHT] not FIGHT_P; returning FALSE")
        return (false)
      }
      fLog ("[I_FIGHT] calling DO_FIGHT(" + LEN + ")")
      DO_FIGHT (LEN)
      fLog ("[I_FIGHT] ends")
    </script>
  </turnscript>

  <function name="AWAKEN" parameters="O">
    fLog("[AWAKEN] " + O.name)
    S = O.STRENGTH
    if (L_P(S,0)) {
      fLog("[AWAKEN] Waking up " + O.name)
      O.STRENGTH = 0 - S
      pippo = EvalToBoolean(O.ACTION + "(GLOBAL.F_CONSCIOUS)")
    }
  </function>

  <turnscript name="I_SWORD">
    <script>
      DEM = I_SWORD
      G = SWORD.TVALUE
      NG = 0
      if (IN_P(SWORD,ADVENTURER)) {
        if (INFESTED_P(GLOBAL.HERE)) {
          NG = 2
        }
        else {
          P = 0
          foreach (T, ScopeExitsForRoom(GLOBAL.HERE)) {
            dLog("[I_SWORD] Checking if " + T.name + " is UEXIT, CEXIT, or DEXIT...")
            if (GetBoolean(T,"UEXIT") or GetBoolean(T,"CEXIT") or GetBoolean(T,"DEXIT")) {
              dLog("[I_SWORD] Checking if " + T.to.name + " is INFESTED_P...")
              if (INFESTED_P(T.to)) {
                dLog("[I_SWORD] " + T.to.name + " is INFESTED_P!")
                NG = 1
              }
            }
          }
        }
        if (NG = G) {
          dLog("[I_SWORD] NG = G; returning false")
          return (false)
        }
        else if (NG = 2) {
          dLog("[I_SWORD] NG = 2")
          msg ("Your sword has begun to glow very brightly.")
        }
        else if (NG = 1) {
          dLog("[I_SWORD] NG = 1")
          msg ("Your sword is glowing with a faint blue glow.")
        }
        else if (NG = 0) {
          dLog("[I_SWORD] NG = 0")
          msg ("Your sword is no longer glowing.")
        }
        dLog("[I_SWORD] Setting sword TVALUE to " + NG + "; returning true")
        SWORD.TVALUE = NG
        return (true)
      }
      else {
        //PUT (DEM, GLOBAL.C_ENABLED_P, 0)
        dLog("[I_SWORD] disabling I_SWORD; returning false")
        DISABLE(DEM)
        return (false)
      }
    </script>
  </turnscript>

  <function name="INFESTED_P" parameters="R" type="boolean">
    foo = false
    foreach (F,GetDirectChildren(R)){
      if (FSET_P(F,"ACTORBIT") and not FSET_P(F,"INVISIBLE")) {
        foo = true
      }
    }
    return (foo)
  </function>

  <turnscript name="I_THIEF">
    <script><![CDATA[
      fLog ("[I_THIEF] ...")
      RM = LOC(THIEF)
      ONCE = false
      FLG = false
      HERE_P = not FSET_P(THIEF,"INVISIBLE")
      if (HERE_P) {
        RM = LOC(THIEF)
      }
      if (RM = TREASURE_ROOM and not RM = GLOBAL.HERE) {
        if (HERE_P) {
          HACK_TREASURES
          HERE_P = false
        }
        DEPOSIT_BOOTY (TREASURE_ROOM)
      }
      else if (RM = GLOBAL.HERE and not FSET_P(RM,"ONBIT") and not IN_P(TROLL,GLOBAL.HERE)) {
        if (THIEF_VS_ADVENTURER(HERE_P)) {
          return (true)
        }
        if (FSET_P(THIEF,"INVISIBLE")) {
          HERE_P = false
        }
      }
      else {
        if (IN_P(THIEF,RM) and not FSET_P(THIEF,"INVISIBLE")) {
          FSET (THIEF, "INVISIBLE")
          HERE_P = false
        }
        if (FSET_P(RM,"TOUCHBIT")) {
          ROB (RM, THIEF, 75)
          if (FSET_P(RM,"MAZEBIT") and FSET_P(GLOBAL.HERE,"MAZEBIT")) {
            FLG = ROB_MAZE(RM)
          }
          else {
            FLG = STEAL_JUNK(RM)
          }
        }
      }
      ONCE = not ONCE
      if (ONCE and not HERE_P) {
        RECOVER_STILETTO
        rooms = GetDirectChildren(ROOMS)
        thief_index = IndexOf(rooms,LOC(THIEF))
        //msg("thief_index: " + thief_index)
        room_count = ListCount(GetDirectChildren(ROOMS)) -1
        if (thief_index = room_count){
          // move thief back the first room
          thief_index = 0
        }
        else {
          thief_index = thief_index + 1
        }
        thief_moved = false
        for(r_i,thief_index,room_count){
          if (not thief_moved){
            target = rooms[r_i]
            if (not FSET_P(target,"SACREDBIT") and FSET_P(target,"RLANDBIT")) {
              RM = target
              fLog ("[I_THIEF]: Thief moving to " + target.alias + ".")
              MOVE (THIEF, target)
              FCLEAR (THIEF, "FIGHTBIT")
              FSET (THIEF, "INVISIBLE")
              GLOBAL.THIEF_HERE = false
              thief_moved = true
              RM = target
            }
          }
        }
      }
      if (not RM = TREASURE_ROOM) {
        DROP_JUNK (RM)
      }
      // TODO - Does something actually NEED to be returned here???
      fLog ("I_THIEF ends")
      return (FLG)
    ]]></script>
  </turnscript>

  <function name="DROP_JUNK" parameters="RM">
    FLG = false
    foreach (X, GetDirectChildren (THIEF)){
      if (X = STILETTO or X = LARGE_BAG) {
        // do nothing
      }
      else if (X.TVALUE = 0 and PROB(30, true)) {
        FCLEAR (X, "INVISIBLE")
        MOVE (X, RM)
        if (not FLG and RM = GLOBAL.HERE) {
          msg ("The robber, rummaging through his bag, dropped a few items he found valueless.")
          FLG = true
        }
      }
    }
  </function>

  <function name="RECOVER_STILETTO">
    if (IN_P(STILETTO,LOC(THIEF))) {
      FSET (STILETTO, "NDESCBIT")
      MOVE (STILETTO, THIEF)
    }
  </function>

  <function name="STEAL_JUNK" parameters="RM" type="boolean">
    robbed = false
    foreach (X, GetDirectChildren (RM)){
      if (X = THIEF or robbed = true){
        //Do nothing
      }
      else if (Equal(X.TVALUE,0) and FSET_P(X,"TAKEBIT") and not FSET_P(X,"SACREDBIT") and not FSET_P(X,"INVISIBLE") and (X = STILETTO or PROB(10,true))) {
        MOVE (X, THIEF)
        FSET (X, "TOUCHBIT")
        FSET (X, "INVISIBLE")
        if (X = ROPE) {
          GLOBAL.DOME_FLAG = false
        }
        if (RM = GLOBAL.HERE) {
          msg ("You suddenly notice that the " + X.alias + " vanished.")
          robbed = true
        }
      }
    }
    return (robbed)
  </function>

  <function name="ROB" parameters="WHAT, WHERE, PROB" type="boolean">
    if (not IsDefined("PROB")) {
      PROB = false
    }
    ROBBED_P = false
    foreach(X,GetDirectChildren(WHAT)) {
      gp_x_tvalue_0_p = false
      if (HasAttribute(X,"TVALUE")){
        if (G_P(X.TVALUE,0)){
          gp_x_tvalue_0_p = true
        }
      }
      if (not FSET_P(X,"INVISIBLE") and not FSET_P(X,"SACREDBIT") and gp_x_tvalue_0_p) {
        MOVE (X, WHERE)
        FSET (X, "TOUCHBIT")
        if (WHERE = THIEF) {
          FSET (X, "INVISIBLE")
        }
        ROBBED_P = true
      }
    }
    return (ROBBED_P)
  </function>

  <function name="JIGS_UP" parameters="DESC, PLAYER_P" type="boolean">
    GLOBAL.WINNER = ADVENTURER
    if (GLOBAL.DEAD) {
      msg ("\r\nIt takes a talented person to be killed while already dead. YOU are such a talent. Unfortunately, it takes a talented person to deal with it. I am not such a talent. Sorry.")
      FINISH
    }
    msg (DESC)
    if (not GLOBAL.LUCKY) {
      msg ("Bad luck, huh?")
    }
    SCORE_UPD (-10)
    msg ("\r\n{=Spaces(4)}****{=Spaces(2)}You have died{=Spaces(2)}****\r\n")
    if (FSET_P(LOC(GLOBAL.WINNER),"VEHBIT")) {
      MOVE (GLOBAL.WINNER, GLOBAL.HERE)
    }
    if (not L_P(GLOBAL.DEATHS,2)) {
      msg ("You clearly are a suicidal maniac.  We don't allow psychotics in the cave, since they may harm other adventurers.  Your remains will be installed in the Land of the Living Dead, where your fellow adventurers may gloat over them.")
      FINISH
    }
    else {
      GLOBAL.DEATHS = GLOBAL.DEATHS + 1
      MOVE (GLOBAL.WINNER, GLOBAL.HERE)
      if (FSET_P(SOUTH_TEMPLE,"TOUCHBIT")) {
        msg ("As you take your last breath, you feel relieved of your burdens. The feeling passes as you find yourself before the gates of Hell, where the spirits jeer at you and deny you entry.  Your senses are disturbed.  The objects in the dungeon appear indistinct, bleached of color, even unreal.\r\n")
        GLOBAL.DEAD = true
        GLOBAL.TROLL_FLAG = true
        GLOBAL.ALWAYS_LIT = true
        GLOBAL.WINNER.ACTION = "DEAD_FUNCTION"
        GOTO (ENTRANCE_TO_HADES, true)
      }
      else {
        msg ("Now, let's take a look here... Well, you probably deserve another chance.  I can't quite fix you up completely, but you can't have everything.")
        GOTO (FOREST_1, true)
      }
      FCLEAR (TRAP_DOOR, "TOUCHBIT")
      GLOBAL.P_CONT = 0
      RANDOMIZE_OBJECTS
      KILL_INTERRUPTS
      RFATAL
    }
    return (true)
  </function>

  <function name="RANDOMIZE_OBJECTS">
    R = false
    if (IN_P(LAMP,GLOBAL.WINNER)) {
      MOVE (LAMP, LIVING_ROOM)
    }
    if (IN_P(COFFIN,GLOBAL.WINNER)) {
      MOVE (COFFIN, EGYPT_ROOM)
    }
    SWORD.TVALUE = 0
    N = FIRST_P(GLOBAL.WINNER)
    L = GLOBAL.ABOVE_GROUND[0]
    exitwhile = false
    while (not exitwhile) {
      F = N
      if (F = NOTHING) {
        // return (null)
        exitwhile = true
      }
      N = NEXT_P(F)
      if (G_P(F.TVALUE,0)) {
        exitwhile2 = false
        while (not exitwhile2) {
          if (R = NOTHING) {
            // TODO - This should be probably just be the first room in the file
            // R = FIRST_P(ROOMS)
            R = WEST_OF_HOUSE
          }
          if (FSET_P(R,"RLANDBIT") and not FSET_P(R,"ONBIT") and PROB(50)) {
            MOVE (F, R)
            // return (null)
            exitwhile2 = true
          }
          else {
            R = NEXT_P(R)
          }
        }
      }
      else {
        MOVE (F, GLOBAL.ABOVE_GROUND[RANDOM(L)])
      }
    }
  </function>

  <function name="KILL_INTERRUPTS" type="boolean">
    DISABLE (I_XB)
    DISABLE (I_XC)
    DISABLE (I_CYCLOPS)
    DISABLE (I_LANTERN)
    DISABLE (I_CANDLES)
    DISABLE (I_SWORD)
    DISABLE (I_FOREST_ROOM)
    DISABLE (I_MATCH)
    FCLEAR (MATCH, "ONBIT")
    return (true)
  </function>

  <function name="BAG_OF_COINS_F" type="boolean">
    return (STUPID_CONTAINER (BAG_OF_COINS, "coins"))
  </function>

  <function name="TRUNK_F" type="boolean">
    return (STUPID_CONTAINER (TRUNK, "jewels"))
  </function>

  <function name="STUPID_CONTAINER" parameters="OBJ, STR" type="boolean">
    if (VERB_P("OPEN CLOSE")) {
      msg ("The " + STR + " are safely inside; there's no need to do that.")
      return (true)
    }
    else if (VERB_P("LOOK_INSIDE EXAMINE")) {
      msg ("There are lots of " + STR + " in there.")
      return (true)
    }
    else if (VERB_P(V_PUT) and GLOBAL.PRSI = OBJ) {
      msg ("Don't be silly. It wouldn't be a " + OBJ.alias + " anymore.")
      return (true)
    }
    return (false)
  </function>

  <function name="DUMB_CONTAINER" type="boolean">
    if (VERB_P("OPEN CLOSE LOOK_INSIDE")) {
      msg ("You can't do that.")
      return (true)
    }
    else if (VERB_P(V_EXAMINE)) {
      msg ("It looks pretty much like a " + GLOBAL.PRSO.alias + ".")
      return (true)
    }
    return (false)
  </function>

  <function name="GARLIC_F" type="boolean">
    if (VERB_P(V_EAT)) {
      REMOVE_CAREFULLY (GLOBAL.PRSO)
      msg ("What the heck! You won't make friends this way, but nobody around here is too friendly anyhow. Gulp!")
      return (true)
    }
    return (false)
  </function>

  <function name="CHAIN_PSEUDO" type="boolean">
    if (VERB_P("TAKE MOVE")) {
      msg ("The chain is secure.")
      return (true)
    }
    else if (VERB_P("RAISE LOWER")) {
      msg ("Perhaps you should do that to the basket.")
      return (true)
    }
    else if (VERB_P(V_EXAMINE)) {
      msg ("The chain secures a basket within the shaft.")
      return (true)
    }
    return (false)
  </function>

  <function name="TROLL_ROOM_F" parameters="RARG" type="boolean">
    if (RARG = "M_ENTER" and IN_P(TROLL,GLOBAL.HERE)) {
      THIS_IS_IT (TROLL)
    }
    return (false)
  </function>

  <function name="FLAMING_P" parameters="OBJ" type="boolean">
    return (FSET_P(OBJ,"FLAMEBIT") and FSET_P(OBJ,"ONBIT"))
  </function>

</library>